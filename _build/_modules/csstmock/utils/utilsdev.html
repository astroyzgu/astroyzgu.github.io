<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>csstmock.utils.utilsdev &mdash; csstmock 0.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            csstmock
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../online-readme/online-readme.html">online-readme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../online-documents.html">online documents</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">csstmock</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changes.html">Change Log</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">csstmock</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">csstmock.utils.utilsdev</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for csstmock.utils.utilsdev</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span> 
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy.cosmology</span> <span class="kn">import</span> <span class="n">FlatLambdaCDM</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">KDTree</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span> 

<div class="viewcode-block" id="auto_firstidcol"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.auto_firstidcol">[docs]</a><span class="k">def</span> <span class="nf">auto_firstidcol</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span>  <span class="n">needid</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span> 
    <span class="n">colnames</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="n">colnames</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span>
    <span class="n">firstcol_dtype</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span> <span class="n">colnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">firstcol_dtype</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="o">~</span><span class="n">needid</span><span class="p">):</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;auto_firstidcol(needid == False): remove the first columns automatically due to int dtype&quot;</span><span class="p">)</span> 
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> 
    <span class="k">elif</span> <span class="p">(</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">firstcol_dtype</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">needid</span><span class="p">):</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;auto_firstidcol(needid == True): add  the first column &#39;number&#39; automatically as serial number&quot;</span><span class="p">)</span> 
        <span class="n">tab</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tab</span><span class="p">))</span> 
        <span class="n">colnames</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">pass</span> 
    <span class="k">return</span> <span class="n">tab</span><span class="p">[</span><span class="n">colnames</span><span class="p">]</span></div>

<div class="viewcode-block" id="file2table"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.file2table">[docs]</a><span class="k">def</span> <span class="nf">file2table</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">usecols</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">colnames</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span> <span class="k">return</span> <span class="n">Table</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;fits&#39;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> 
        <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;ascii&#39;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="p">)</span>
    <span class="n">colnames_of_table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">usecols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="n">usecols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames_of_table</span><span class="p">))</span>
    <span class="n">old_colnames</span> <span class="o">=</span> <span class="n">colnames_of_table</span><span class="p">[</span><span class="n">usecols</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">usecols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">usecols</span><span class="p">)</span> 
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">old_colnames</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">colnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="n">t</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span><span class="n">old_colnames</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">t</span></div>

<div class="viewcode-block" id="groupbysum"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.groupbysum">[docs]</a><span class="k">def</span> <span class="nf">groupbysum</span><span class="p">(</span><span class="n">groupbyid</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function calculates the sum of weights for each unique group ID.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    groupbyid (numpy array): A numpy array containing group IDs.</span>
<span class="sd">    weights   (numpy array): A numpy array containing weights corresponding to each group ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">    uniq_id  (numpy array): A numpy array of unique group IDs.</span>
<span class="sd">    sumofwht (numpy array): A numpy array of the sum of weights for each unique group ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uniq_id</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">groupbyid</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">bins</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uniq_id</span><span class="p">,</span> <span class="n">uniq_id</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sumofwht</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">groupbyid</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">uniq_id</span><span class="p">,</span> <span class="n">sumofwht</span></div>

<div class="viewcode-block" id="histogram_bootstrap"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.histogram_bootstrap">[docs]</a><span class="k">def</span> <span class="nf">histogram_bootstrap</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is a wrapper for numpy&#39;s histogram function, adding a bootstrap parameter for bootstrap resampling.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    a (array_like): Input data, will be converted into a one-dimensional array.</span>
<span class="sd">    bins (int, optional): The number of bins for the histogram, default is 10.</span>
<span class="sd">    bootstrap (int, optional): The number of bootstrap resamples. If None, no bootstrap resampling is performed. Default is None.</span>
<span class="sd">    range (tuple, optional): The range of the histogram. Default is None.</span>
<span class="sd">    density (bool, optional): If True, the returned histogram is normalized by dividing by the bin width and the number of observations, so that the integral under the histogram is 1. Default is None.</span>
<span class="sd">    weights (array_like, optional): The weights for each value in the input data. Default is None.</span>

<span class="sd">    Returns:</span>
<span class="sd">    hist (ndarray): The values of the histogram. </span>
<span class="sd">        If bootstrap is not None, returns a 2D array where each row is a bootstrap resample of the histogram.</span>
<span class="sd">    edges (ndarray): The bin edges of the histogram.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">ndat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="n">density</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bootstrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndat</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ndat</span><span class="p">,</span> <span class="n">bootstrap</span><span class="p">))</span>
        <span class="n">dat2d</span><span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">rand</span><span class="p">]</span>
        <span class="n">dat2d</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">weights</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
            <span class="n">weights2d</span>      <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">rand</span><span class="p">]</span>
            <span class="n">weights2d</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="n">phi_n</span>  <span class="o">=</span> <span class="p">[];</span> 
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bootstrap</span><span class="p">):</span> 
            <span class="n">hist</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">dat2d</span><span class="p">[:,</span><span class="n">ii</span><span class="p">],</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">bins</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="n">density</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">weights2d</span><span class="p">[:,</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">phi_n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> 
        <span class="n">phi_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">phi_n</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> 
        <span class="k">return</span> <span class="n">phi_n</span><span class="p">,</span> <span class="n">edges</span> 
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">return</span> <span class="n">hist</span><span class="p">,</span>  <span class="n">edges</span> </div>
    
<div class="viewcode-block" id="fracndim"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.fracndim">[docs]</a><span class="k">def</span> <span class="nf">fracndim</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bin_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">fracndim2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bin_list</span> <span class="o">=</span> <span class="n">bin_list</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">)</span></div>

<div class="viewcode-block" id="fracndim2"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.fracndim2">[docs]</a><span class="k">def</span> <span class="nf">fracndim2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bin_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    outershape: 循环层数和每层的次数</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">bin_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    
    <span class="n">outershape</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">bins</span> <span class="ow">in</span> <span class="n">bin_list</span><span class="p">]</span> 
    <span class="k">for</span> <span class="n">iloop</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outershape</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> 
            <span class="n">bin_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="n">iloop</span><span class="p">])</span>  <span class="p">)</span>
            <span class="n">bin_list</span><span class="p">[</span><span class="n">iloop</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bin_new</span><span class="p">,</span> <span class="n">bin_new</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> 
            
    <span class="n">hist2</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">hist1</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">,:],</span> <span class="n">bins</span><span class="o">=</span><span class="n">edges</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">fracndim</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">hist1</span><span class="o">/</span><span class="n">hist2</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">fracndim</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">hist2</span>
    <span class="k">return</span> <span class="n">fracndim</span><span class="p">,</span> <span class="n">edges</span></div>

<div class="viewcode-block" id="fracndim1"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.fracndim1">[docs]</a><span class="k">def</span> <span class="nf">fracndim1</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bin_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    outershape: 循环层数和每层的次数</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">bin_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    
    <span class="n">outershape</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">bins</span> <span class="ow">in</span> <span class="n">bin_list</span><span class="p">]</span> 
    <span class="k">for</span> <span class="n">iloop</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outershape</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> 
            <span class="n">bin_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="n">iloop</span><span class="p">])</span>  <span class="p">)</span>
            <span class="n">bin_list</span><span class="p">[</span><span class="n">iloop</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bin_new</span><span class="p">,</span> <span class="n">bin_new</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> 
            <span class="n">outershape</span><span class="p">[</span><span class="n">iloop</span><span class="p">]</span><span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_list</span><span class="p">[</span><span class="n">iloop</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">outer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">outershape</span> <span class="p">)</span> 
    <span class="n">loops</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">outershape</span><span class="p">]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="k">while</span> <span class="n">loops</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="n">outershape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> 
        <span class="k">for</span> <span class="n">iloop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">outershape</span><span class="p">)</span> <span class="p">):</span> 
            <span class="n">lo</span> <span class="o">=</span> <span class="n">bin_list</span><span class="p">[</span><span class="n">iloop</span><span class="p">][</span><span class="n">loops</span><span class="p">[</span><span class="n">iloop</span><span class="p">]]</span>
            <span class="n">up</span> <span class="o">=</span> <span class="n">bin_list</span><span class="p">[</span><span class="n">iloop</span><span class="p">][</span><span class="n">loops</span><span class="p">[</span><span class="n">iloop</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> 
            <span class="n">indx_</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="n">iloop</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lo</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="n">iloop</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">up</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iloop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">index</span> <span class="o">=</span> <span class="n">indx_</span>
            <span class="k">if</span> <span class="n">iloop</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">&amp;</span><span class="n">indx_</span>
        <span class="nb">print</span><span class="p">(</span> <span class="n">loops</span> <span class="p">)</span>
    <span class="c1">#--------------------------------------------</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">outer</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">loops</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">index</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">outer</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">loops</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            
    <span class="c1">#---------------------------------------------</span>
    <span class="c1"># control the loops</span>
        <span class="n">loops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">iloop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">outershape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">):</span> 
            <span class="k">if</span> <span class="n">loops</span><span class="p">[</span><span class="n">iloop</span><span class="p">]</span> <span class="o">==</span> <span class="n">outershape</span><span class="p">[</span><span class="n">iloop</span><span class="p">]</span> <span class="p">:</span> 
                <span class="n">loops</span><span class="p">[</span><span class="n">iloop</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span> <span class="mi">1</span>
                <span class="n">loops</span><span class="p">[</span><span class="n">iloop</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># print(count, loops, outershape)</span>
        <span class="n">iloop</span><span class="o">=</span><span class="mi">0</span>
    <span class="c1">#---------------------------------------------</span>
    <span class="k">return</span> <span class="n">outer</span><span class="p">,</span> <span class="n">bin_list</span></div>


<div class="viewcode-block" id="lftools"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools">[docs]</a><span class="k">class</span> <span class="nc">lftools</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update:  calzmax2 - zmax[np.inan(zmax)] = 0 </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H0</span><span class="p">,</span> <span class="n">Om0</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span>   <span class="o">=</span> <span class="n">FlatLambdaCDM</span><span class="p">(</span><span class="n">H0</span><span class="p">,</span> <span class="n">Om0</span><span class="o">=</span><span class="n">Om0</span><span class="p">);</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">zgrid</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_zgrid</span><span class="p">(</span><span class="n">zup</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="n">zlo</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">precision</span><span class="p">),</span> <span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span><span class="p">,</span> <span class="n">Omega_M</span> <span class="o">=</span> <span class="n">Om0</span><span class="p">,</span> <span class="n">H0</span> <span class="o">=</span> <span class="n">H0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zgal</span><span class="p">,</span> <span class="n">mag_app</span><span class="p">,</span> <span class="n">kcorr</span><span class="p">,</span> <span class="n">kcorr_func</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">skycov</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">igrp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zgrp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rank</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mag_cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">Msun</span> <span class="o">=</span> <span class="mf">4.83</span><span class="p">,</span> <span class="n">Omega_M</span> <span class="o">=</span> <span class="mf">0.315</span><span class="p">,</span> <span class="n">H0</span> <span class="o">=</span> <span class="mf">67.4</span><span class="p">,</span> <span class="n">zmaxiter</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zgal</span>    <span class="o">=</span> <span class="n">zgal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mag_app</span> <span class="o">=</span> <span class="n">mag_app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kcorr</span>   <span class="o">=</span> <span class="n">kcorr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kcorr_func</span> <span class="o">=</span> <span class="n">kcorr_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngal</span>    <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zgal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span>   <span class="o">=</span> <span class="n">FlatLambdaCDM</span><span class="p">(</span><span class="n">H0</span><span class="p">,</span> <span class="n">Om0</span><span class="o">=</span><span class="n">Omega_M</span><span class="p">);</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">zgrid</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_zgrid</span><span class="p">(</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">Omega_M</span> <span class="o">=</span> <span class="n">Omega_M</span><span class="p">,</span> <span class="n">H0</span> <span class="o">=</span> <span class="n">Omega_M</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zmaxgrid</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_zmaxgrid</span><span class="p">(</span><span class="n">kcorr_func</span><span class="o">=</span><span class="n">kcorr_func</span><span class="p">,</span> <span class="n">zgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrid</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">Msun</span>    <span class="o">=</span> <span class="n">Msun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">skycov</span> <span class="o">=</span> <span class="n">skycov</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="p">,</span> <span class="n">igrp</span> <span class="o">=</span> <span class="n">igrp</span><span class="p">,</span> <span class="n">zgrp</span> <span class="o">=</span> <span class="n">zgrp</span><span class="p">,</span> <span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span><span class="p">,</span> <span class="n">mag_cut</span> <span class="o">=</span> <span class="n">mag_cut</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">loglum</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app2abs</span><span class="p">(</span><span class="n">zgal</span><span class="p">,</span> <span class="n">mag_app</span><span class="p">,</span> <span class="n">kcorr</span> <span class="o">=</span> <span class="n">kcorr</span><span class="p">,</span> <span class="n">Msun</span> <span class="o">=</span> <span class="n">Msun</span><span class="p">,</span> <span class="n">use_h</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">zgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrid</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zmax</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calzmax</span><span class="p">(</span><span class="n">zgal</span><span class="p">,</span> <span class="n">mag_app</span><span class="p">,</span> <span class="n">mag_cut</span> <span class="o">=</span> <span class="n">mag_cut</span><span class="p">,</span> <span class="n">zmaxgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmaxgrid</span><span class="p">,</span> <span class="n">zgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrid</span><span class="p">)</span>
        <span class="c1"># print(np.shape(self.zmax) )</span>

<div class="viewcode-block" id="lftools.app2abs"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.app2abs">[docs]</a>    <span class="k">def</span> <span class="nf">app2abs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zgal</span><span class="p">,</span> <span class="n">mag_app</span><span class="p">,</span> <span class="n">kcorr</span><span class="p">,</span> <span class="n">Msun</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_h</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convet apparent magnitude to absolute magnitude to a given redshift. </span>
<span class="sd">        mag_abs = mag_app - 5*np.log10(DL[Mpc]) - 25 - kcorr</span>
<span class="sd">        mag_abs - 5*log10(h) = mag_app - 5*np.log10(DL[Mpc/h]) - 25 - kcorr - 5*log10(h)</span>

<span class="sd">        mag_abs - Msun = -2.5*log10( L/Lsun )</span>
<span class="sd">        mag_abs - 5*log10(h) - Msun = -2.5*log10( L/Lsun ) - 5*log10(h)</span>
<span class="sd">                                    = -2.5*log10( L*h*h/Lsun )</span>
<span class="sd">        log10( L/(Lsun/h^2) ) = -0.4(mag_abs - 5*log10(h) - Msun) </span>

<span class="sd">        Parameter: </span>
<span class="sd">        ----------</span>
<span class="sd">        mag_app: array_like</span>
<span class="sd">            apparent magnitude of galaxies</span>
<span class="sd">        z: array_like</span>
<span class="sd">            redshift of galaxies</span>
<span class="sd">        kcorr: array_like, or constant</span>
<span class="sd">        Msun: array_like, or None</span>
<span class="sd">            if Msun is None (defaults), return magnitude</span>
<span class="sd">            if Msun is settled, e.g., 4.83, return luminosity</span>
<span class="sd">        use_h: bool</span>
<span class="sd">            if use_h is True (defults), the results of absolute magnitude (or luminosity) is Mabs - 5*log10(h) (or L[Lsun/h^2])</span>
<span class="sd">            if use_h is False, the results of absolute magnitude (or luminosity) is Mabs (or L[Lsun])</span>
<span class="sd">        Results: </span>
<span class="sd">        ----------- </span>
<span class="sd">        magnitude/log10(luminosity): array_like </span>
<span class="sd">            use Msun and use_h to control the output</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">zgrid</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrid</span> <span class="c1"># lftools.build_zgrid(precision = 4, Omega_M = Omega_M, H0 = H0)</span>
        <span class="n">zgal</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">zgal</span><span class="p">)</span>
        <span class="n">mag_app</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mag_app</span><span class="p">)</span>
        <span class="n">kcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kcorr</span><span class="p">)</span>
        <span class="n">ngal</span>    <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zgal</span><span class="p">)</span>
        <span class="n">DL</span>      <span class="o">=</span> <span class="n">zgrid</span><span class="o">.</span><span class="n">z2DL</span><span class="p">(</span><span class="n">zgal</span><span class="p">)</span>   <span class="c1"># luminosity distance, Unit: X/h [Mpc]， e.g., 100 [Mpc/h]</span>
        <span class="k">if</span> <span class="n">use_h</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">DL</span> <span class="o">=</span> <span class="n">DL</span><span class="o">/</span><span class="n">zgrid</span><span class="o">.</span><span class="n">h</span> <span class="c1"># 100 [Mpc/h] --&gt; 142.86 Mpc if h = 0.7 </span>
        <span class="n">DM</span>   <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">DL</span><span class="p">)</span> <span class="o">+</span> <span class="mi">25</span> <span class="c1"># DISTANCE MODULE</span>
        <span class="n">mag_abs</span> <span class="o">=</span> <span class="n">mag_app</span> <span class="o">-</span> <span class="n">DM</span> <span class="o">-</span> <span class="n">kcorr</span>
        <span class="k">if</span> <span class="n">Msun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">loglum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.4</span><span class="o">*</span><span class="p">(</span><span class="n">mag_abs</span> <span class="o">-</span> <span class="n">Msun</span><span class="p">)</span>  
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loglum</span><span class="p">)</span>  <span class="c1"># if use_h == True, Unit: Lsun/h^2 </span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mag_abs</span><span class="p">)</span> <span class="c1"># if use_h == True, Mabs - 5*log10(h) </span></div>

<div class="viewcode-block" id="lftools.calzmax"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.calzmax">[docs]</a>    <span class="k">def</span> <span class="nf">calzmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zgal</span><span class="p">,</span> <span class="n">mag_app</span><span class="p">,</span> <span class="n">mag_cut</span><span class="p">,</span> <span class="n">kcorr_func</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            mag_abs = mag_app - 5*np.log10(DL(z)[Mpc]) - 25 - kcorr(z)</span>
<span class="sd">            mag_abs = mag_cut - 5*np.log10(DL(zmax)[Mpc]) - 25 - kcorr(zmax)</span>
<span class="sd">    </span>
<span class="sd">            ==&gt; mag_cut - mag_app =  func(zmax) - func(z),   func(z) = kcorr(z) + 5*np.log10(DL(z)[Mpc])</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">zgal</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">zgal</span><span class="p">)</span>
        <span class="n">mag_app</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mag_app</span><span class="p">)</span>
        <span class="n">zgrid</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrid</span> <span class="c1"># lftools.build_zgrid(precision = 4, Omega_M = Omega_M, H0 = H0)</span>
        <span class="n">zmaxgrid</span> <span class="o">=</span> <span class="n">lftools</span><span class="o">.</span><span class="n">build_zmaxgrid</span><span class="p">(</span><span class="n">kcorr_func</span><span class="p">,</span> <span class="n">zgrid</span> <span class="o">=</span> <span class="n">zgrid</span><span class="p">)</span> 
        <span class="n">dmag</span> <span class="o">=</span> <span class="n">mag_cut</span> <span class="o">-</span> <span class="n">mag_app</span> <span class="o">+</span> <span class="n">zmaxgrid</span><span class="o">.</span><span class="n">func1</span><span class="p">(</span><span class="n">zgal</span><span class="p">)</span>
        <span class="n">zmax</span> <span class="o">=</span> <span class="n">zmaxgrid</span><span class="o">.</span><span class="n">func2</span><span class="p">(</span><span class="n">dmag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">zmax</span></div>

<div class="viewcode-block" id="lftools.callf"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.callf">[docs]</a>    <span class="k">def</span> <span class="nf">callf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zlo</span><span class="p">,</span> <span class="n">zup</span><span class="p">,</span> <span class="n">zgal</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">loglum</span><span class="p">,</span> <span class="n">wht</span><span class="p">,</span> <span class="n">loglum_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">skycov</span> <span class="o">=</span> <span class="mf">41252.96</span><span class="p">):</span> 
        <span class="n">indx_z</span>   <span class="o">=</span> <span class="p">(</span><span class="n">zlo</span> <span class="o">&lt;</span> <span class="n">zgal</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">zgal</span> <span class="o">&lt;=</span> <span class="n">zup</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">zmax</span><span class="o">&gt;=</span><span class="n">zgal</span><span class="p">)</span>
        <span class="c1">#if wht is None: wht = loglum*0+1.0</span>
        <span class="n">loglum</span> <span class="o">=</span> <span class="n">loglum</span><span class="p">[</span><span class="n">indx_z</span><span class="p">]</span>
        <span class="n">zgal</span> <span class="o">=</span> <span class="n">zgal</span><span class="p">[</span><span class="n">indx_z</span><span class="p">]</span>
        <span class="n">zmax</span> <span class="o">=</span> <span class="n">zmax</span><span class="p">[</span><span class="n">indx_z</span><span class="p">];</span> <span class="n">zmax</span><span class="p">[</span><span class="n">zmax</span> <span class="o">&gt;</span> <span class="n">zup</span><span class="p">]</span> <span class="o">=</span> <span class="n">zup</span> 
        <span class="n">wht</span>  <span class="o">=</span> <span class="n">wht</span><span class="p">[</span><span class="n">indx_z</span><span class="p">]</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrid</span><span class="o">.</span><span class="n">z2VC</span><span class="p">(</span><span class="n">zmax</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrid</span><span class="o">.</span><span class="n">z2VC</span><span class="p">(</span><span class="n">zlo</span><span class="p">)</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="mf">41252.96</span><span class="o">/</span><span class="n">skycov</span><span class="o">/</span><span class="n">vmax</span><span class="p">;</span> <span class="c1"># 1/vmax</span>
        <span class="n">weight</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span><span class="o">|</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">weight</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">loglum_x</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">loglum_bin</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">loglum_bin</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  
        <span class="n">numden_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap</span><span class="p">(</span><span class="n">loglum</span><span class="p">,</span> <span class="n">loglum_bin</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="o">*</span><span class="n">wht</span><span class="p">,</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="n">bootstrap</span> <span class="p">)</span>
        <span class="n">lf0</span> <span class="o">=</span> <span class="n">numden_y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">ave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numden_y</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span> <span class="n">numden_y</span><span class="p">,</span> <span class="n">ddof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1">#-- print(np.shape(lf0), np.shape(ave), np.shape(std) ) </span>
        <span class="n">logelo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ave</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ave</span><span class="o">-</span><span class="n">std</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">logeup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ave</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ave</span><span class="o">+</span><span class="n">std</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">hist</span><span class="p">,</span><span class="n">edge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span> <span class="n">loglum</span><span class="p">,</span> <span class="n">loglum_bin</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">loglum_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ave</span><span class="p">),</span> <span class="n">logelo</span><span class="p">,</span> <span class="n">logeup</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">lf0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">res</span> </div>

<div class="viewcode-block" id="lftools.bootstrap"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.bootstrap">[docs]</a>    <span class="k">def</span> <span class="nf">bootstrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loglum</span><span class="p">,</span> <span class="n">loglum_bin</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        bootstrap1 is used to calculate the luminosity function and the uncertainty, </span>
<span class="sd">        which do the boostrap by random sampling of galaxies. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">loglumc</span>    <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">loglum_bin</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">loglum_bin</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="p">)</span>
        <span class="n">numden</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loglumc</span><span class="p">),</span> <span class="n">bootstrap</span><span class="p">))</span> 
        <span class="n">weight</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span><span class="o">|</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">weight</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ngal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">loglum</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> 
        <span class="n">nwht</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">ngal</span><span class="p">,</span> <span class="n">bootstrap</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># number weight </span>
        <span class="n">rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ngal</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngal</span><span class="p">,</span> <span class="n">bootstrap</span><span class="p">))</span>
        <span class="c1">#</span>
        <span class="c1">#------ bootstrap  </span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bootstrap</span><span class="p">):</span> 
            <span class="n">uniq</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rand</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">return_counts</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
            <span class="n">nwht</span><span class="p">[</span><span class="n">uniq</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span>  <span class="o">=</span> <span class="n">counts</span>
            <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">nwht</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">numden</span><span class="p">)):</span> 
            <span class="n">indx</span> <span class="o">=</span> <span class="p">(</span><span class="n">loglum_bin</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">loglum</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">loglum</span> <span class="o">&lt;</span> <span class="n">loglum_bin</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> 
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                <span class="n">numden</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">numden</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nwht</span><span class="p">[</span><span class="n">indx</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">weight</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">numden</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">loglum_bin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">loglum_bin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> </div>


<div class="viewcode-block" id="lftools.initialize"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skycov</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">igrp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zgrp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rank</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mag_cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skycov</span> <span class="o">=</span> <span class="n">skycov</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zgrp</span> <span class="o">=</span> <span class="n">zgrp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">igrp</span> <span class="o">=</span> <span class="n">igrp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mag_cut</span> <span class="o">=</span> <span class="n">mag_cut</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_app</span><span class="p">)</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>  <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1">#print(&#39;Weight of galaxies is not specific, set it to %s. &#39;% self.weight)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> 
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lftools: Calculate luminosity function&#39;</span><span class="p">)</span> 
            <span class="c1"># print(&#39;Cannot calculate conditional luminosity function. (id, redshift, c/s) of groups is not provided.&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;lf&#39;</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="c1"># self.skycov = 4*np.pi*(180/np.pi)**2</span>
            <span class="c1">#print(&#39;sky coverage of galaxies is not specific, set it to %s deg^2. &#39;%self.skycov) </span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lftools: Calculate conditional luminosity function&#39;</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;clf&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> </div>
<span class="c1">#    @classmethod</span>
<span class="c1">#    def data(cls, data, mag_cut, kcorr_func, skycov, Msun):        </span>
<span class="c1">#        data[]</span>
<span class="c1">#        return cls</span>
<div class="viewcode-block" id="lftools.check"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.check">[docs]</a>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> 
        <span class="n">ngal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">);</span> 
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngal</span><span class="p">)</span>
        <span class="n">nsel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">zmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span> <span class="n">zmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#--- select </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1"> galaxies at </span><span class="si">%s</span><span class="s1"> &lt;= z &lt;= </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">nsel</span><span class="p">,</span> <span class="n">ngal</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">)</span> <span class="p">)</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#--- luminosity: </span><span class="si">%s</span><span class="s1"> &lt;= log(L) &lt;= </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loglum</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loglum</span><span class="p">)))</span></div>
        
<div class="viewcode-block" id="lftools.build_zgrid"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.build_zgrid">[docs]</a>    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">build_zgrid</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">zup</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="n">zlo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">precision</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Omega_M</span> <span class="o">=</span> <span class="mf">0.315</span><span class="p">,</span> <span class="n">H0</span> <span class="o">=</span> <span class="mf">67.4</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="s1">&#39;log&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Build the gird of redshift according to the precision. </span>
<span class="sd">        Generate the corrsponding distance and volume as a reference. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
        <span class="n">cosmo</span>   <span class="o">=</span> <span class="n">FlatLambdaCDM</span><span class="p">(</span><span class="n">H0</span><span class="p">,</span> <span class="n">Om0</span><span class="o">=</span><span class="n">Omega_M</span><span class="p">);</span> 
        <span class="c1">#---------- redshift grid --&gt; DC, DL (Mpc/h)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">Omega_M</span> <span class="o">=</span> <span class="n">Omega_M</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">H0</span>    <span class="o">=</span> <span class="n">H0</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">cosmo</span> <span class="o">=</span> <span class="n">cosmo</span> 
        <span class="bp">cls</span><span class="o">.</span><span class="n">zup</span>   <span class="o">=</span> <span class="n">zup</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">zlo</span>   <span class="o">=</span> <span class="n">zlo</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">h</span>     <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">H0</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="mf">100.0</span> <span class="c1"># 67.4 km / (Mpc s)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span> 
            <span class="bp">cls</span><span class="o">.</span><span class="n">log1pz</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">zlo</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">zup</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">precision</span><span class="p">),</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">precision</span><span class="p">))</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">zref</span>  <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="bp">cls</span><span class="o">.</span><span class="n">log1pz</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span> 
            <span class="bp">cls</span><span class="o">.</span><span class="n">zref</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">zlo</span><span class="p">,</span> <span class="n">zup</span><span class="o">+</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">precision</span><span class="p">),</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">precision</span><span class="p">))</span> 
            <span class="bp">cls</span><span class="o">.</span><span class="n">log1pz</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">zref</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1">#--------</span>
        <span class="c1">#log1pz = np.arange(np.log10(1+zlo), np.log10(1+0.1) + 10**(-precision), 10**(-precision))</span>
        <span class="c1">#zref1  = 10**log1pz - 1</span>
        <span class="c1">#zref2  = np.arange(0.1+10**(-precision), zup+10**(-precision), 10**(-precision) )        </span>
        <span class="c1">#cls.zref  = np.hstack(zref1, zref2)</span>
        <span class="c1">#--------</span>
        
        <span class="c1"># np.arange(zlo, zup+10**(-precision), 10**(-precision)); # zref = [0., 0.001, 0.002, ..]</span>
        <span class="c1"># 142.86 [Mpc] * 0.7 = 100 [Mpc/h]</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">DCref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cosmo</span><span class="o">.</span><span class="n">comoving_distance</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">zref</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">h</span><span class="p">;</span> <span class="c1"># comoving distance, Unit: Mpc/h</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">DLref</span> <span class="o">=</span>  <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="bp">cls</span><span class="o">.</span><span class="n">zref</span><span class="p">)</span><span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">DCref</span>    <span class="c1"># luminosity distance, Unit: Mpc/h</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">VCref</span> <span class="o">=</span> <span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">DCref</span><span class="o">**</span><span class="mi">3</span> <span class="c1"># comoving   volume, Mpc^3/h^3</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">z2DC</span>  <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">zref</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DCref</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">z2DL</span>  <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">zref</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DLref</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">z2VC</span>  <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">zref</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">VCref</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">DC2z</span>  <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">DCref</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">zref</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">DL2z</span>  <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">DLref</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">zref</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">VC2z</span>  <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">VCref</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">zref</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span></div>

<div class="viewcode-block" id="lftools.build_ngrid1"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.build_ngrid1">[docs]</a>    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">build_ngrid1</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">precision</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">zgrid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Omega_M</span> <span class="o">=</span> <span class="mf">0.315</span><span class="p">,</span> <span class="n">H0</span> <span class="o">=</span> <span class="mf">67.4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Input group redshift and group id, return the number as a function of redshift. </span>
<span class="sd">        Use zref as redshift bin to count. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">zgrid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">zgrid</span> <span class="o">=</span> <span class="n">lftools</span><span class="o">.</span><span class="n">build_zgrid</span><span class="p">(</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span><span class="p">,</span> <span class="n">Omega_M</span> <span class="o">=</span> <span class="n">Omega_M</span><span class="p">,</span> <span class="n">H0</span> <span class="o">=</span> <span class="n">H0</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">uniq</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">z</span>  <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">index</span><span class="p">];</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">edge</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">zgrid</span><span class="o">.</span><span class="n">zref</span><span class="p">)</span>
        <span class="n">cumhist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
        <span class="n">cumhist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cumhist</span><span class="p">,</span> <span class="n">cumhist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">z2ngrid</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">cumhist</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;previous&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z2ngrid</span></div>
<div class="viewcode-block" id="lftools.bootstrap_ngal"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.bootstrap_ngal">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">bootstrap_ngal</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ngal</span><span class="p">,</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">igrp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        #---- 对ngal个星系进行随机抽样， 或者对星系团以及其中的星系进行随机抽样</span>
<span class="sd">        #---- 返回：numgal_rand, 星系在每一次抽样中出现的次数</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">numgal_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngal</span><span class="p">,</span> <span class="n">bootstrap</span><span class="p">))</span> <span class="c1"># 星系在每一次抽样中出现的次数</span>
        <span class="k">if</span> <span class="n">igrp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">idxgal</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ngal</span><span class="p">,</span> <span class="p">(</span><span class="n">ngal</span><span class="p">,</span> <span class="n">bootstrap</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bootstrap</span><span class="p">):</span> 
                <span class="n">uniq</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">idxgal</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">return_counts</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
                <span class="n">numgal_rand</span><span class="p">[</span><span class="n">uniq</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span>
                <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">numgal_rand</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">ngal</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">igrp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="s1">&#39;input igrp did not have same size with number of galaxies&#39;</span><span class="p">)</span> 
            <span class="n">uniq</span><span class="p">,</span> <span class="n">inverse</span><span class="p">,</span> <span class="n">rich</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">igrp</span><span class="p">,</span> <span class="n">return_inverse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">ngrp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniq</span><span class="p">)</span> <span class="c1"># 星系群的总数</span>
            <span class="c1">#print(&#39;星系群编号&#39;, uniq, &#39;， 共%s个星系群&#39;%ngrp)</span>
            <span class="c1">#print(&#39;成员星系数&#39;, rich) </span>
            <span class="n">numgrp_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngrp</span><span class="p">,</span> <span class="n">bootstrap</span><span class="p">))</span> <span class="c1"># 星系团在每一次抽样中出现的次数</span>
            <span class="c1">#--- 开始随机抽样</span>
            <span class="n">idxgrp</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ngrp</span><span class="p">,</span> <span class="p">(</span><span class="n">ngrp</span><span class="p">,</span> <span class="n">bootstrap</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bootstrap</span><span class="p">):</span> 
                <span class="n">idxgrp_uniq</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">idxgrp</span><span class="p">[:,</span><span class="n">ii</span><span class="p">],</span> <span class="n">return_counts</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">numgrp_rand</span><span class="p">[</span><span class="n">idxgrp_uniq</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span>
                <span class="n">numgal_rand</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">numgrp_rand</span><span class="p">[</span><span class="n">inverse</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span>
                <span class="c1"># print(&#39;星系团在抽样中出现的次数:&#39;, numgrp_rand[:,ii], &#39;星系在抽样中出现的次数:&#39;, numgal_rand[:,ii] )</span>
                <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">numgal_rand</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> 
        <span class="k">return</span> <span class="n">numgal_rand</span> </div>
<div class="viewcode-block" id="lftools.build_ngrid2"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.build_ngrid2">[docs]</a>    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">build_ngrid2</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">precision</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Input group redshift and group id, return the number as a function of redshift. </span>
<span class="sd">        Use input redshift to calculate the cumulative counts. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">z</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">z</span><span class="p">);</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">precision</span><span class="p">)</span> <span class="p">)</span> 
        <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">z2ngrid</span><span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">precision</span><span class="p">),</span> <span class="n">num</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="n">num</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">z2ngrid</span> </div>

<div class="viewcode-block" id="lftools.build_ngrid"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.build_ngrid">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">build_ngrid</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        mag_app = -2.5log10(L) + 5log10(DL1)</span>
<span class="sd">        mag_cut = -2.5log10(L) + 5log10(DL2) </span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">lftools</span><span class="o">.</span><span class="n">build_ngrid2</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="lftools.build_zmaxgrid"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.build_zmaxgrid">[docs]</a>    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">build_zmaxgrid</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">kcorr_func</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zgrid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Omega_M</span> <span class="o">=</span> <span class="mf">0.315</span><span class="p">,</span> <span class="n">H0</span> <span class="o">=</span> <span class="mf">67.4</span><span class="p">,):</span> 
        <span class="k">if</span> <span class="n">kcorr_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">dmag</span>   <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">zgrid</span><span class="o">.</span><span class="n">DLref</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dmag</span>   <span class="o">=</span> <span class="n">kcorr_func</span><span class="p">(</span><span class="n">zgrid</span><span class="o">.</span><span class="n">zref</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">zgrid</span><span class="o">.</span><span class="n">DLref</span><span class="p">)</span> 
        <span class="bp">cls</span><span class="o">.</span><span class="n">dmag</span>    <span class="o">=</span> <span class="n">dmag</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">func1</span>  <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">zgrid</span><span class="o">.</span><span class="n">zref</span><span class="p">,</span> <span class="n">dmag</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">func2</span>  <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">dmag</span><span class="p">,</span> <span class="n">zgrid</span><span class="o">.</span><span class="n">zref</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>        
        <span class="k">return</span> <span class="bp">cls</span> </div>

    
<div class="viewcode-block" id="lftools.calzmax2"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.calzmax2">[docs]</a>    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">calzmax2</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">zgal</span><span class="p">,</span> <span class="n">mag_app</span><span class="p">,</span> <span class="n">mag_cut</span><span class="p">,</span> <span class="n">kcorr_func</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zgrid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zmaxgrid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Omega_M</span> <span class="o">=</span> <span class="mf">0.315</span><span class="p">,</span> <span class="n">H0</span> <span class="o">=</span> <span class="mf">67.4</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            mag_abs = mag_app - 5*np.log10(DL(z)[Mpc]) - 25 - kcorr(z)</span>
<span class="sd">            mag_abs = mag_cut - 5*np.log10(DL(zmax)[Mpc]) - 25 - kcorr(zmax)</span>
<span class="sd">    </span>
<span class="sd">            ==&gt; mag_cut - mag_app =  func(zmax) - func(z),   func(z) = kcorr(z) + 5*np.log10(DL(z)[Mpc])</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lftools: Calculate zmax of galaxies (v2)&#39;</span><span class="p">)</span>
        <span class="n">zgal</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">zgal</span><span class="p">)</span>
        <span class="n">mag_app</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mag_app</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zgrid</span>    <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">zgrid</span>    <span class="o">=</span> <span class="n">lftools</span><span class="o">.</span><span class="n">build_zgrid</span><span class="p">(</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">Omega_M</span> <span class="o">=</span> <span class="n">Omega_M</span><span class="p">,</span> <span class="n">H0</span> <span class="o">=</span> <span class="n">H0</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">zmaxgrid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">zmaxgrid</span> <span class="o">=</span> <span class="n">lftools</span><span class="o">.</span><span class="n">build_zmaxgrid</span><span class="p">(</span><span class="n">kcorr_func</span><span class="p">,</span> <span class="n">zgrid</span> <span class="o">=</span> <span class="n">zgrid</span><span class="p">)</span> 
        <span class="n">dmag</span> <span class="o">=</span> <span class="n">mag_cut</span> <span class="o">-</span> <span class="n">mag_app</span> <span class="o">+</span> <span class="n">zmaxgrid</span><span class="o">.</span><span class="n">func1</span><span class="p">(</span><span class="n">zgal</span><span class="p">)</span>
        <span class="n">zmax</span> <span class="o">=</span> <span class="n">zmaxgrid</span><span class="o">.</span><span class="n">func2</span><span class="p">(</span><span class="n">dmag</span><span class="p">)</span>
        <span class="n">zmax</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">zmax</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="k">return</span> <span class="n">zmax</span></div>

<div class="viewcode-block" id="lftools.calzmax1"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.calzmax1">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">calzmax1</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">zgal</span><span class="p">,</span> <span class="n">mag_app</span><span class="p">,</span> <span class="n">mag_cut</span><span class="p">,</span> <span class="n">kcorr_func</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">zgrid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Omega_M</span> <span class="o">=</span> <span class="mf">0.315</span><span class="p">,</span> <span class="n">H0</span> <span class="o">=</span> <span class="mf">67.4</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        mag_app = -2.5log10(L) + 5log10(DL1)</span>
<span class="sd">        mag_cut = -2.5log10(L) + 5log10(DL2) </span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lftools: Calculate zmax of galaxies (v1)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">zgrid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">zgrid</span>   <span class="o">=</span> <span class="n">lftools</span><span class="o">.</span><span class="n">build_zgrid</span><span class="p">(</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">Omega_M</span> <span class="o">=</span> <span class="n">Omega_M</span><span class="p">,</span> <span class="n">H0</span> <span class="o">=</span> <span class="n">H0</span><span class="p">)</span> 
        <span class="n">zgal</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">zgal</span><span class="p">)</span>
        <span class="n">mag_app</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mag_app</span><span class="p">)</span>
        <span class="n">DL1</span>  <span class="o">=</span> <span class="n">zgrid</span><span class="o">.</span><span class="n">z2DL</span><span class="p">(</span><span class="n">zgal</span><span class="p">)</span>  <span class="c1"># luminosity distance, Unit: Mpc/h</span>
        <span class="n">DL2</span>  <span class="o">=</span> <span class="n">mag_cut</span> <span class="o">-</span> <span class="n">mag_app</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">DL1</span><span class="p">)</span>
        <span class="n">DL2</span>  <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">DL2</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span>
        <span class="n">z1</span>   <span class="o">=</span> <span class="n">zgrid</span><span class="o">.</span><span class="n">DL2z</span><span class="p">(</span><span class="n">DL2</span><span class="p">)</span>
        <span class="k">for</span>  <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">iter</span><span class="p">):</span>
            <span class="n">DL2</span>  <span class="o">=</span> <span class="n">mag_cut</span> <span class="o">-</span> <span class="n">mag_app</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">DL1</span><span class="p">)</span> <span class="o">+</span> <span class="n">kcorr_func</span><span class="p">(</span><span class="n">zgal</span><span class="p">)</span> <span class="o">-</span> <span class="n">kcorr_func</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span>  
            <span class="n">DL2</span>  <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">DL2</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span> 
            <span class="n">z1</span>   <span class="o">=</span> <span class="n">zgrid</span><span class="o">.</span><span class="n">DL2z</span><span class="p">(</span><span class="n">DL2</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">z1</span></div>
    
<div class="viewcode-block" id="lftools.calzmax0"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.calzmax0">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">calzmax0</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        mag_app = -2.5log10(L) + 5log10(DL1)</span>
<span class="sd">        mag_cut = -2.5log10(L) + 5log10(DL2) </span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">lftools</span><span class="o">.</span><span class="n">calzmax2</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="lftools.app2abs1"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.app2abs1">[docs]</a>    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">app2abs1</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">zgal</span><span class="p">,</span> <span class="n">mag_app</span><span class="p">,</span> <span class="n">kcorr</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Msun</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_h</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">zgrid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Omega_M</span> <span class="o">=</span> <span class="mf">0.315</span><span class="p">,</span> <span class="n">H0</span> <span class="o">=</span> <span class="mf">67.4</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convet apparent magnitude to absolute magnitude to a given redshift. </span>
<span class="sd">        mag_abs = mag_app - 5*np.log10(DL[Mpc]) - 25 - kcorr</span>
<span class="sd">        mag_abs - 5*log10(h) = mag_app - 5*np.log10(DL[Mpc/h]) - 25 - kcorr - 5*log10(h)</span>

<span class="sd">        mag_abs - Msun = -2.5*log10( L/Lsun )</span>
<span class="sd">        mag_abs - 5*log10(h) - Msun = -2.5*log10( L/Lsun ) - 5*log10(h)</span>
<span class="sd">                                    = -2.5*log10( L*h*h/Lsun )</span>
<span class="sd">        log10( L/(Lsun/h^2) ) = -0.4(mag_abs - 5*log10(h) - Msun) </span>

<span class="sd">        Parameter: </span>
<span class="sd">        ----------</span>
<span class="sd">        mag_app: array_like</span>
<span class="sd">            apparent magnitude of galaxies</span>
<span class="sd">        z: array_like</span>
<span class="sd">            redshift of galaxies</span>
<span class="sd">        kcorr: array_like, or constant</span>
<span class="sd">        Msun: array_like, or None</span>
<span class="sd">            if Msun is None (defaults), return magnitude</span>
<span class="sd">            if Msun is settled, e.g., 4.83, return luminosity</span>
<span class="sd">        use_h: bool</span>
<span class="sd">            if use_h is True (defults), the results of absolute magnitude (or luminosity) is Mabs - 5*log10(h) (or L[Lsun/h^2])</span>
<span class="sd">            if use_h is False, the results of absolute magnitude (or luminosity) is Mabs (or L[Lsun])</span>
<span class="sd">        Results: </span>
<span class="sd">        ----------- </span>
<span class="sd">        magnitude/log10(luminosity): array_like </span>
<span class="sd">            use Msun and use_h to control the output</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lftools: Convet apparent magnitude to absolute magnitude (or luminosity)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zgrid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">zgrid</span> <span class="o">=</span> <span class="n">lftools</span><span class="o">.</span><span class="n">build_zgrid</span><span class="p">(</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Omega_M</span> <span class="o">=</span> <span class="n">Omega_M</span><span class="p">,</span> <span class="n">H0</span> <span class="o">=</span> <span class="n">H0</span><span class="p">)</span>
        <span class="n">zgal</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">at_least1d</span><span class="p">(</span><span class="n">zgal</span> <span class="p">)</span>
        <span class="n">mag_app</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">at_least1d</span><span class="p">(</span><span class="n">mag_app</span><span class="p">)</span> 
        <span class="n">kcorr</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">at_least1d</span><span class="p">(</span><span class="n">kcorr</span><span class="p">)</span> 
        <span class="n">ngal</span>    <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zgal</span><span class="p">)</span>
        <span class="n">DL</span>      <span class="o">=</span> <span class="n">zgrid</span><span class="o">.</span><span class="n">z2DL</span><span class="p">(</span><span class="n">zgal</span><span class="p">)</span>   <span class="c1"># luminosity distance, Unit: X/h [Mpc]， e.g., 100 [Mpc/h]</span>
        <span class="k">if</span> <span class="n">use_h</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">DL</span> <span class="o">=</span> <span class="n">DL</span><span class="o">/</span><span class="n">zgrid</span><span class="o">.</span><span class="n">h</span> <span class="c1"># 100 [Mpc/h] --&gt; 142.86 Mpc if h = 0.7 </span>
        <span class="n">DM</span>   <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">DL</span><span class="p">)</span> <span class="o">+</span> <span class="mi">25</span> <span class="c1"># DISTANCE MODULE</span>
        <span class="n">mag_abs</span> <span class="o">=</span> <span class="n">mag_app</span> <span class="o">-</span> <span class="n">DM</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">kcorr</span>
        <span class="k">if</span> <span class="n">Msun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">loglum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.4</span><span class="o">*</span><span class="p">(</span><span class="n">mag_abs</span> <span class="o">-</span> <span class="n">Msun</span><span class="p">)</span>  
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loglum</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># if use_h == True, Unit: Lsun/h^2 </span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mag_abs</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="c1"># if use_h == True, Mabs - 5*log10(h) </span></div>

<div class="viewcode-block" id="lftools.bootstrap1"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.bootstrap1">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">bootstrap1</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">loglum</span><span class="p">,</span> <span class="n">loglum_bin</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        bootstrap1 is used to calculate the luminosity function and the uncertainty, </span>
<span class="sd">        which do the boostrap by random sampling of galaxies. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lftools: bootstrap to calculate the luminosity function and the uncertainty&#39;</span><span class="p">)</span> 
        <span class="n">loglumc</span>    <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">loglum_bin</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">loglum_bin</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="p">)</span>
        <span class="n">numden</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loglumc</span><span class="p">),</span> <span class="n">bootstrap</span><span class="p">))</span> 
        <span class="n">weight</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span><span class="o">|</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">weight</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ngal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">loglum</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> 
        <span class="n">nwht</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">ngal</span><span class="p">,</span> <span class="n">bootstrap</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># number weight </span>
        <span class="n">rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ngal</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngal</span><span class="p">,</span> <span class="n">bootstrap</span><span class="p">))</span>
        <span class="c1">#</span>
        <span class="c1">#------ bootstrap  </span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bootstrap</span><span class="p">):</span> 
            <span class="n">uniq</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rand</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">return_counts</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
            <span class="n">nwht</span><span class="p">[</span><span class="n">uniq</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span>  <span class="o">=</span> <span class="n">counts</span>
            <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">nwht</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">numden</span><span class="p">)):</span> 
            <span class="n">indx</span> <span class="o">=</span> <span class="p">(</span><span class="n">loglum_bin</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">loglum</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">loglum</span> <span class="o">&lt;</span> <span class="n">loglum_bin</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> 
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                <span class="n">numden</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">numden</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nwht</span><span class="p">[</span><span class="n">indx</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">weight</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">loglumc</span><span class="p">,</span> <span class="n">numden</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">loglum_bin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">loglum_bin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  </div>
    
<div class="viewcode-block" id="lftools.bootstrap3"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.bootstrap3">[docs]</a>    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">bootstrap3</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">loglum</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">igrp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        bootstrap2 is used to calculate the conditional luminosity function and the uncertainty, </span>
<span class="sd">        which do the boostrap by random sampling of groups. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lftools: bootstrap to calculate the uncertainty of (conditional) luminosity function&#39;</span><span class="p">)</span> 
        <span class="n">xc</span>     <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="p">)</span>
        <span class="n">ngal</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">loglum</span><span class="p">)</span> <span class="c1"># 输入星系的总数</span>
        <span class="n">weight</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span><span class="o">|</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">weight</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 预处理，如权重为异常值， 则不考虑后续的记数</span>
        <span class="c1">#------------------------------------------------------------------------------------------------------</span>
        <span class="n">numgal_rand</span> <span class="o">=</span> <span class="n">lftools</span><span class="o">.</span><span class="n">bootstrap_ngal</span><span class="p">(</span><span class="n">ngal</span><span class="p">,</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="p">,</span> <span class="n">igrp</span> <span class="o">=</span> <span class="n">igrp</span><span class="p">)</span> 
        
        <span class="c1">#------------------------------------------------------------------------------------------------------</span>
        <span class="c1">#</span>
        <span class="c1">#--- bootstrap </span>
        <span class="c1">#</span>
        <span class="n">yboots0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xc</span><span class="p">),</span> <span class="n">bootstrap</span><span class="p">))</span> <span class="c1"># 用于存放central结果</span>
        <span class="n">yboots1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xc</span><span class="p">),</span> <span class="n">bootstrap</span><span class="p">))</span> <span class="c1"># 用于存放satellite结果</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xc</span><span class="p">)):</span> 
            <span class="c1"># central CLF</span>
            <span class="n">indx</span>   <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">bins</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                <span class="n">yboots0</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">yboots0</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numgal_rand</span><span class="p">[</span><span class="n">indx</span><span class="p">,:]</span><span class="o">*</span><span class="n">weight</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> 
            <span class="c1"># satellite CLF</span>
            <span class="n">indx</span>   <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">bins</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                <span class="n">yboots1</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">yboots1</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numgal_rand</span><span class="p">[</span><span class="n">indx</span><span class="p">,:]</span><span class="o">*</span><span class="n">weight</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> 
                
        <span class="k">return</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yboots0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">yboots1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> </div>
    
<div class="viewcode-block" id="lftools.bootstrap2"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.bootstrap2">[docs]</a>    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">bootstrap2</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">igrp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        bootstrap2 is used to calculate the conditional luminosity function and the uncertainty, </span>
<span class="sd">        which do the boostrap by random sampling of groups. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lftools: bootstrap to calculate the uncertainty of (conditional) luminosity function&#39;</span><span class="p">)</span> 
        <span class="n">xc</span>     <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="p">)</span>
        <span class="n">nx</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> 
        <span class="n">ngal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># 输入星系的总数</span>
        <span class="n">weight</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span><span class="o">|</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">weight</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 预处理，如权重为异常值， 则不考虑后续的记数</span>
        <span class="c1">#------------------------------------------------------------------------------------------------------</span>
        <span class="n">numgal_rand</span> <span class="o">=</span> <span class="n">lftools</span><span class="o">.</span><span class="n">bootstrap_ngal</span><span class="p">(</span><span class="n">ngal</span><span class="p">,</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="p">,</span> <span class="n">igrp</span> <span class="o">=</span> <span class="n">igrp</span><span class="p">)</span> 
        <span class="c1">#------------------------------------------------------------------------------------------------------</span>
        <span class="c1">#</span>
        <span class="c1">#--- bootstrap </span>
        <span class="c1">#</span>
        <span class="n">yboots</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xc</span><span class="p">),</span> <span class="n">bootstrap</span><span class="p">))</span> <span class="c1"># 用于存放结果</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xc</span><span class="p">)):</span> 
            <span class="n">indx</span>   <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">bins</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                <span class="n">yboots</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">yboots</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numgal_rand</span><span class="p">[</span><span class="n">indx</span><span class="p">,:]</span><span class="o">*</span><span class="n">weight</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> 
                <span class="c1"># print((&#39;[%.2f, %.2f]&#39;)%(bins[ii], bins[ii+1]), &#39;:&#39;, 1/weight[indx][:3]) </span>
        <span class="k">return</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yboots</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> </div>
        
        
<div class="viewcode-block" id="lftools.run"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.lftools.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zlo</span><span class="p">,</span> <span class="n">zup</span><span class="p">,</span> <span class="n">loglum_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ngal</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;lf&#39;</span><span class="p">:</span>  
            <span class="n">indx_z</span>   <span class="o">=</span> <span class="p">(</span><span class="n">zlo</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span> <span class="o">&lt;</span> <span class="n">zup</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;clf&#39;</span><span class="p">:</span> 
            <span class="c1"># rank: 必要，区分中心星系和卫星星系</span>
            <span class="c1"># zgrp: 星系群的红移，计算星系团的累积数目和红移的关系numgrp(&lt;z)。有，直接使用；无，利用中心星系的红移。 </span>
            <span class="c1"># igrp: 星系群的编号，1.用于找到在红移范围内的星系团对应的成员星系; 2. 用于boostrap是对星系团随机抽样</span>
            <span class="c1">#          有: 选择在红移范围内的星系群， 若成员星系超出了红移的范围的，也纳入其中</span>
            <span class="c1">#          无: 只能选择在红移范围内的星系，只能直接对星系随机抽样</span>
            <span class="c1"># </span>
            <span class="c1">#--- 构建红移z与小于z的星系团数目之间的关系 numgrp_lt_zmax = z2ngrid(zmax)</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="c1"># 如果group的红移已经提供了， 直接使用</span>
                <span class="n">indx_z</span>  <span class="o">=</span> <span class="p">(</span><span class="n">zlo</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrp</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zgrp</span> <span class="o">&lt;</span> <span class="n">zup</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">)</span>
                <span class="n">zgrp</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrp</span><span class="p">[</span><span class="n">indx_z</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span><span class="mi">0</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="c1"># 如果group的红移没有提供了， 则使用中心星系的红移作为group的红移 </span>
                <span class="n">indx_z</span>  <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">)</span>
                <span class="n">zgrp</span>    <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">[</span><span class="n">indx_z</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span><span class="mi">0</span><span class="p">)]</span>
            <span class="c1"># 星系群的红移，计算星系团的累积数目和红移的关系numgrp(&lt;z)</span>
            <span class="n">z2ngrid</span>  <span class="o">=</span> <span class="n">lftools</span><span class="o">.</span><span class="n">build_ngrid</span><span class="p">(</span> <span class="n">zgrp</span><span class="p">[(</span><span class="n">zlo</span> <span class="o">&lt;</span> <span class="n">zgrp</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">zgrp</span> <span class="o">&lt;</span> <span class="n">zup</span><span class="p">)])</span>
            <span class="c1">#</span>
            <span class="c1">#--- 选择出用于计算CLF的星系样本 </span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">igrp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  
                <span class="c1"># </span>
                <span class="c1"># 如果提供了groupid, 则选择满足红移范围的的group。 若成员星系超出了红移的范围的，也纳入其中</span>
                <span class="c1"># </span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
                    <span class="n">igrp</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">igrp</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">zlo</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrp</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zgrp</span> <span class="o">&lt;</span> <span class="n">zup</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">)]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>     
                    <span class="n">igrp</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">igrp</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">zlo</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span> <span class="o">&lt;</span> <span class="n">zup</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">)]</span>
                <span class="n">uniq_igrp</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span> <span class="n">igrp</span> <span class="p">)</span> 
                <span class="n">indx_z</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">igrp</span><span class="p">,</span> <span class="n">uniq_igrp</span><span class="p">)</span> 
                <span class="n">indx_z</span>   <span class="o">=</span> <span class="n">indx_z</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">indx_z</span>   <span class="o">=</span> <span class="p">(</span><span class="n">zlo</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrp</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zgrp</span> <span class="o">&lt;</span> <span class="n">zup</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">)</span> <span class="c1">#</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgrp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>     <span class="n">indx_z</span>   <span class="o">=</span> <span class="p">(</span><span class="n">zlo</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span> <span class="o">&lt;</span> <span class="n">zup</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">zgal</span><span class="p">)</span> <span class="c1">#</span>

        <span class="n">index</span>   <span class="o">=</span> <span class="n">index</span> <span class="o">&amp;</span> <span class="n">indx_z</span>
        <span class="n">zmax</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmax</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">loglum</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglum</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;lf&#39;</span><span class="p">:</span> 
            <span class="c1">#print(&#39;Running to calculate the luminosity function&#39;)</span>
            <span class="n">allsky</span><span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">;</span> 
            <span class="n">omega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skycov</span><span class="o">/</span><span class="n">allsky</span>
            <span class="n">zmax</span><span class="p">[</span><span class="n">zmax</span> <span class="o">&gt;</span> <span class="n">zup</span><span class="p">]</span>  <span class="o">=</span> <span class="n">zup</span><span class="p">;</span> 
            <span class="n">vmax</span>  <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z2VC</span><span class="p">(</span><span class="n">zmax</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">z2VC</span><span class="p">(</span><span class="n">zlo</span><span class="p">)</span> <span class="p">)</span> 
            <span class="n">loglumc</span><span class="p">,</span> <span class="n">numden</span> <span class="o">=</span> <span class="n">lftools</span><span class="o">.</span><span class="n">bootstrap1</span><span class="p">(</span><span class="n">loglum</span><span class="p">,</span> <span class="n">loglum_bin</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">weight</span><span class="o">/</span><span class="n">vmax</span><span class="p">,</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;clf&#39;</span><span class="p">:</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">igrp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="n">igrp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">igrp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="c1">#zgal = self.zgal[index]; # print( np.max(zgal), np.min(zgal) )</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">igrp</span> <span class="o">=</span> <span class="kc">None</span> 
            <span class="c1">#print(&#39;Running to calculate the conditional luminosity function&#39;)</span>
            <span class="n">zmax</span><span class="p">[</span><span class="n">zmax</span> <span class="o">&gt;</span> <span class="n">zup</span><span class="p">]</span>  <span class="o">=</span> <span class="n">zup</span><span class="p">;</span> 
            <span class="n">numgrp_lt_zmax</span>  <span class="o">=</span> <span class="n">z2ngrid</span><span class="p">(</span><span class="n">zmax</span><span class="p">)</span> <span class="o">-</span> <span class="n">z2ngrid</span><span class="p">(</span><span class="n">zlo</span><span class="p">);</span> 
            
            <span class="n">loglumc</span><span class="p">,</span> <span class="n">numden</span> <span class="o">=</span> <span class="n">lftools</span><span class="o">.</span><span class="n">bootstrap2</span><span class="p">(</span><span class="n">loglum</span><span class="p">,</span> <span class="n">loglum_bin</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">weight</span><span class="o">/</span><span class="n">numgrp_lt_zmax</span><span class="p">,</span> <span class="n">igrp</span> <span class="o">=</span> <span class="n">igrp</span><span class="p">,</span> <span class="n">bootstrap</span><span class="o">=</span><span class="n">bootstrap</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span> 
            <span class="c1">#loglumc, numden = lftools.bootstrap1(loglum, loglum_bin, weight = 1.0/weight/numgrp_lt_zmax, bootstrap=bootstrap, verbose = self.verbose) </span>

        <span class="c1">#-------- summary bootstrap results</span>
        <span class="n">lfdata</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loglumc</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loglumc</span><span class="p">)):</span>
            <span class="n">numden_</span> <span class="o">=</span> <span class="n">numden</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> 
            <span class="n">numden_</span><span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">numden_</span><span class="p">)</span><span class="o">|</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">numden_</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">numden_</span> <span class="o">=</span> <span class="n">numden_</span><span class="p">[</span><span class="n">numden_</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> 
            <span class="n">ave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numden_</span> <span class="p">)</span> 
            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span> <span class="n">numden_</span><span class="p">,</span> <span class="n">ddof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> 
            <span class="n">lfdata</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">loglumc</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">lfdata</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ave</span><span class="p">)</span>
            <span class="n">lfdata</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">lfdata</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ave</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ave</span><span class="o">-</span><span class="n">err</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">lfdata</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ave</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ave</span><span class="o">+</span><span class="n">err</span><span class="p">)</span> <span class="p">)</span> 
            
        <span class="n">hist</span><span class="p">,</span><span class="n">edge</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>  <span class="n">loglum</span><span class="p">,</span> <span class="n">loglum_bin</span><span class="p">)</span>
        <span class="n">lfdata</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span>

        <span class="c1"># numden = np.ma.masked_array(numden, mask = np.isnan(numden) ) </span>
        <span class="c1"># ave = np.mean(numden, axis = 1) </span>
        <span class="c1"># err_lo = np.log10(ave) - np.log10(ave-err)</span>
        <span class="c1"># err_hi = np.log10(ave+err) - np.log10(ave) </span>
        <span class="c1"># lfdata = np.vstack([loglumc, np.log10(ave), np.log10(err), err_lo, err_hi]).T </span>
        <span class="k">return</span> <span class="n">lfdata</span><span class="p">,</span> <span class="n">numden</span></div></div>

    


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy.io</span>  <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span> 

<div class="viewcode-block" id="rgbimg"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.rgbimg">[docs]</a><span class="k">class</span> <span class="nc">rgbimg</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The requirements for the images are to </span>
<span class="sd">        1. present an homogeneous background, </span>
<span class="sd">        2. distinguish bright to faint objects</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgs</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span>
        
<div class="viewcode-block" id="rgbimg.from_cube"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.rgbimg.from_cube">[docs]</a>    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">from_cube</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cube</span><span class="p">):</span> 
        <span class="k">pass</span></div>
    
<div class="viewcode-block" id="rgbimg.from_fits"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.rgbimg.from_fits">[docs]</a>    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">from_fits</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filenames</span><span class="p">):</span> 
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;inputs != 3&#39;</span><span class="p">)</span> 
        <span class="n">imgs</span><span class="p">,</span> <span class="n">hdrs</span> <span class="o">=</span> <span class="n">rgbimg</span><span class="o">.</span><span class="n">readimgs</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">aslist</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span></div>
    <span class="c1">#--- end __init__ end ---# </span>
    
<div class="viewcode-block" id="rgbimg.readimg_worker"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.rgbimg.readimg_worker">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">readimg_worker</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ihdu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        write for mutliprocessing</span>
<span class="sd">        read image array from a file (jpg or fits). </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;fits&#39;</span><span class="p">]:</span> 
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot; Unsupported filename: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">]:</span> 
            <span class="c1"># import imageio</span>
            <span class="kn">import</span> <span class="nn">imageio.v2</span> <span class="k">as</span> <span class="nn">imageio</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> 
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">/</span><span class="mf">255.0</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1">#print(img.shape)</span>
                <span class="c1">#img = np.transpose(img,(1,2,0))</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="kc">None</span> 
            <span class="k">except</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">hdr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;fits&#39;</span><span class="p">:</span> 
            <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="n">ihdu</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">ihdu</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
                <span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">hdr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">img</span><span class="p">,</span> <span class="n">hdr</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="rgbimg.readimgs"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.rgbimg.readimgs">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">readimgs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">ihdu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aslist</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        load all the images and convert them into a tensor (indx, xpix, ypix, 1).  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">hdrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inputfile</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span> 
            <span class="n">img_</span><span class="p">,</span> <span class="n">hdr_</span> <span class="o">=</span> <span class="n">rgbimg</span><span class="o">.</span><span class="n">readimg_worker</span><span class="p">(</span><span class="n">inputfile</span><span class="p">,</span> <span class="n">ihdu</span> <span class="o">=</span> <span class="n">ihdu</span><span class="p">)</span> 
            <span class="n">imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_</span><span class="p">)</span>
            <span class="n">hdrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdr_</span><span class="p">)</span>
            
        <span class="c1"># print(&#39;### Finish reading %i files&#39;%(len(inputs)))</span>
        <span class="k">if</span> <span class="n">aslist</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> 
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">):</span> <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span> <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,</span> <span class="p">:]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;###-----------------------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;### The shape of image array = &#39;</span><span class="p">,</span> <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">hdrs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;###-----------------------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;### return as list&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">hdrs</span></div>
<div class="viewcode-block" id="rgbimg.forward"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.rgbimg.forward">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">minimum</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">stretch</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="p">):</span> 
        <span class="k">return</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">Q</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arcsinh</span><span class="p">(</span> <span class="n">Q</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">minimum</span><span class="p">)</span><span class="o">/</span><span class="n">stretch</span> <span class="p">)</span></div>
<div class="viewcode-block" id="rgbimg.inverse"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.rgbimg.inverse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">minimum</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">stretch</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">):</span> 
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sinh</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">Q</span><span class="p">)</span><span class="o">*</span><span class="n">stretch</span><span class="o">/</span><span class="n">Q</span> <span class="o">+</span> <span class="n">minimum</span></div>
<div class="viewcode-block" id="rgbimg.easy_bkg"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.rgbimg.easy_bkg">[docs]</a>    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">easy_bkg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span> 
        <span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clipped_stats</span><span class="p">,</span> <span class="n">SigmaClip</span>
        <span class="kn">from</span> <span class="nn">photutils.segmentation</span> <span class="kn">import</span> <span class="n">detect_threshold</span><span class="p">,</span> <span class="n">detect_sources</span>
        <span class="kn">from</span> <span class="nn">photutils.utils</span> <span class="kn">import</span> <span class="n">circular_footprint</span>
        <span class="n">sigma_clip</span>  <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">threshold</span>   <span class="o">=</span> <span class="n">detect_threshold</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">)</span>
        <span class="n">segment_img</span> <span class="o">=</span> <span class="n">detect_sources</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">footprint</span> <span class="o">=</span> <span class="n">circular_footprint</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">segment_img</span><span class="o">.</span><span class="n">make_source_mask</span><span class="p">(</span><span class="n">footprint</span><span class="o">=</span><span class="n">footprint</span><span class="p">)</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span></div>
    
<div class="viewcode-block" id="rgbimg.run"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.rgbimg.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">photutils.segmentation</span> <span class="kn">import</span> <span class="n">detect_threshold</span><span class="p">,</span> <span class="n">detect_sources</span><span class="p">,</span> <span class="n">deblend_sources</span><span class="p">,</span> <span class="n">SourceCatalog</span>
        <span class="n">image_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">bkg_r</span><span class="p">,</span> <span class="n">std_r</span> <span class="o">=</span> <span class="n">rgbimg</span><span class="o">.</span><span class="n">easy_bkg</span><span class="p">(</span><span class="n">image_r</span><span class="p">);</span> 
        <span class="n">image_g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">bkg_g</span><span class="p">,</span> <span class="n">std_g</span> <span class="o">=</span> <span class="n">rgbimg</span><span class="o">.</span><span class="n">easy_bkg</span><span class="p">(</span><span class="n">image_g</span><span class="p">);</span> 
        <span class="n">image_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="n">bkg_b</span><span class="p">,</span> <span class="n">std_b</span> <span class="o">=</span> <span class="n">rgbimg</span><span class="o">.</span><span class="n">easy_bkg</span><span class="p">(</span><span class="n">image_b</span><span class="p">);</span> 
        <span class="n">r</span> <span class="o">=</span> <span class="n">image_r</span> <span class="o">-</span> <span class="n">bkg_r</span><span class="c1">#/std_r</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">image_g</span> <span class="o">-</span> <span class="n">bkg_g</span><span class="c1">#/std_g</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">image_b</span> <span class="o">-</span> <span class="n">bkg_b</span><span class="c1">#/std_b</span>
        <span class="c1"># 4.9,5.7,7.8 </span>
        <span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">SqrtStretch</span>
        <span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">ZScaleInterval</span>
        <span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">make_lupton_rgb</span>
        <span class="n">lo_val</span><span class="p">,</span> <span class="n">up_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">g</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">b</span><span class="o">.</span><span class="n">flatten</span><span class="p">())),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">))</span> 
        <span class="n">image</span> <span class="o">=</span> <span class="n">make_lupton_rgb</span><span class="p">(</span><span class="mf">0.7</span><span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="mf">1.1</span><span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="mf">1.8</span><span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">minimum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">)</span>        
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">/</span><span class="mi">255</span>
        <span class="k">return</span> <span class="n">image</span></div></div>

<div class="viewcode-block" id="sex"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.sex">[docs]</a><span class="k">class</span> <span class="nc">sex</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> 
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">hdr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span> 
        <span class="kn">import</span> <span class="nn">photutils</span>
        <span class="c1"># print(photutils.__version___) # == 1.3.0 ) </span>
        <span class="n">npixels</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img</span>       <span class="o">=</span> <span class="n">img</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdr</span>       <span class="o">=</span> <span class="n">hdr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>   <span class="o">=</span> <span class="n">verbose</span>
        <span class="c1"># self.mask      = detect.make_source_mask(self.img, nsigma=1, npixels=npixels, dilate_size=10)</span>
        <span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">convolve</span>
        <span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">Gaussian2DKernel</span>
        <span class="kn">from</span> <span class="nn">photutils.segmentation</span> <span class="kn">import</span> <span class="n">detect_threshold</span><span class="p">,</span> <span class="n">detect_sources</span><span class="p">,</span> <span class="n">deblend_sources</span><span class="p">,</span> <span class="n">SourceCatalog</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">detect_threshold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1">#, mask=self.mask)</span>
        <span class="n">sigma</span>          <span class="o">=</span> <span class="mf">1.5</span><span class="p">;</span> <span class="n">npixels</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">kernel</span>         <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">x_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">y_size</span><span class="o">=</span><span class="mi">3</span><span class="p">);</span> 
        <span class="n">convolved_data</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span> <span class="c1"># kernel.normalize()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seg</span>       <span class="o">=</span> <span class="n">detect_sources</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="n">npixels</span><span class="p">)</span> <span class="c1"># , kernel=kernel)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">seg</span>       <span class="o">=</span> <span class="n">deblend_sources</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="n">npixels</span><span class="p">,</span> <span class="n">nlevels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">contrast</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tab</span>       <span class="o">=</span> <span class="n">SourceCatalog</span><span class="p">(</span>  <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg</span><span class="p">)</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tab</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;segment_flux&#39;</span><span class="p">])</span> <span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  
                <span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">wcs</span>
                <span class="n">wcs2d</span>           <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdr</span><span class="p">)</span>
                <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">wcs2d</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ra</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">!=</span><span class="mi">0</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Eesy Source Extract get </span><span class="si">%s</span><span class="s1"> potential sources&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">tab</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="sex.return_mainobj"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.sex.return_mainobj">[docs]</a>    <span class="k">def</span> <span class="nf">return_mainobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">segm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span> 
            <span class="n">segm</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">bkg</span>  <span class="o">=</span> <span class="o">~</span><span class="n">segm</span>
        <span class="k">elif</span>  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">)</span>  <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
            <span class="n">segm</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">segm</span> <span class="o">=</span> <span class="n">segm</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">bkg</span>  <span class="o">=</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">seg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> 
            <span class="n">x0</span>  <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">x</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">])</span>
            <span class="n">y</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])</span>
            <span class="n">pix_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">pix_dist</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> 
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span> <span class="n">t</span><span class="o">.</span><span class="n">remove_row</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
            <span class="n">segm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
            <span class="n">segm</span><span class="o">.</span><span class="n">remove_label</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
            <span class="n">segm</span> <span class="o">=</span> <span class="n">segm</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">bkg</span>  <span class="o">=</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">seg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span> 
        <span class="k">return</span>  <span class="n">segm</span><span class="p">,</span> <span class="n">bkg</span>    </div>
 
<div class="viewcode-block" id="sex.return_stamps"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.sex.return_stamps">[docs]</a>    <span class="k">def</span> <span class="nf">return_stamps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">Cutout2D</span>
        <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span> 
        <span class="c1"># positions = [(ix, iy) for ix, iy in zip(self.tab[&#39;ra&#39;],self.tab[&#39;dec&#39;] )]</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">)</span> <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span> <span class="p">)]</span>
        <span class="n">bbox_ysize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;bbox_xmax&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;bbox_xmin&#39;</span><span class="p">]</span>
        <span class="n">bbox_xsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;bbox_ymax&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">[</span><span class="s1">&#39;bbox_ymin&#39;</span><span class="p">]</span> 
        <span class="n">sizes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">)</span> <span class="k">for</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bbox_xsize</span><span class="p">,</span> <span class="n">bbox_ysize</span> <span class="p">)]</span>
        <span class="n">iths</span>       <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_imgs</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_hdrs</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="k">for</span> <span class="n">ith</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">iths</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">sizes</span><span class="p">):</span> 
            <span class="n">hdr_wcs2d</span>  <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span> 
            <span class="n">cutout</span>     <span class="o">=</span> <span class="n">Cutout2D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">hdr_wcs2d</span><span class="p">)</span>
            <span class="n">new_img</span>    <span class="o">=</span> <span class="n">cutout</span><span class="o">.</span><span class="n">data</span>
            <span class="n">hdu</span>        <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">new_img</span><span class="p">)</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="n">cutout</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">())</span>
            <span class="n">new_hdr</span>    <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">new_img</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_hdrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">new_hdr</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_imgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_hdrs</span></div>

<div class="viewcode-block" id="sex.return_Rectangles"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.sex.return_Rectangles">[docs]</a>    <span class="k">def</span> <span class="nf">return_Rectangles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">stamp_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">bool</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tab</span><span class="p">)):</span> 
            <span class="n">w_</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_hdrs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">w</span>  <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr</span> <span class="p">)</span>
            <span class="n">ra_min</span><span class="p">,</span> <span class="n">dec_min</span> <span class="o">=</span> <span class="n">w_</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ix_min</span><span class="p">,</span> <span class="n">iy_min</span>  <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="n">ra_min</span><span class="p">,</span> <span class="n">dec_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ix_min</span><span class="p">,</span> <span class="n">iy_min</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">([</span><span class="n">ix_min</span><span class="p">,</span> <span class="n">iy_min</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> 
            <span class="n">xy</span>     <span class="o">=</span> <span class="p">(</span><span class="n">ix_min</span><span class="p">,</span> <span class="n">iy_min</span><span class="p">);</span> 
            <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_imgs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_imgs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ix_max</span> <span class="o">=</span> <span class="n">ix_min</span> <span class="o">+</span> <span class="n">width</span>
            <span class="n">iy_max</span> <span class="o">=</span> <span class="n">iy_min</span> <span class="o">+</span> <span class="n">height</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.0</span><span class="p">))</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">stamp_mask</span><span class="p">[</span><span class="n">iy_min</span><span class="p">:</span><span class="n">iy_max</span><span class="p">,</span> <span class="n">ix_min</span><span class="p">:</span><span class="n">ix_max</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
	<span class="c1"># p = PatchCollection(patches, edgecolors=&#39;r&#39;, facecolors=&#39;None&#39;, linewidth = 3 ) </span>
	<span class="c1"># ax.add_collection(p) </span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stamp_mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">patches</span></div></div>

<div class="viewcode-block" id="mockimg"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg">[docs]</a><span class="k">class</span> <span class="nc">mockimg</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    build mock image</span>
<span class="sd">    </span>
<span class="sd">    parameter </span>
<span class="sd">    ---------</span>
<span class="sd">    a1:</span>
<span class="sd">    d1:</span>
<span class="sd">    stps: </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">wcs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">survey</span> <span class="o">=</span> <span class="s1">&#39;desi&#39;</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="s1">&#39;./__cache__/&#39;</span><span class="p">,</span> <span class="n">enlarge</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">ngal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">a1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">=</span> <span class="n">cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stps</span> <span class="o">=</span> <span class="n">stps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span>    <span class="o">=</span> <span class="n">wcs</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">survey</span> <span class="o">=</span> <span class="n">survey</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enlarge</span><span class="o">=</span> <span class="n">enlarge</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
        
            
<div class="viewcode-block" id="mockimg.readimg_worker"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.readimg_worker">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">readimg_worker</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ihdu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        write for mutliprocessing</span>
<span class="sd">        read image array from a file (jpg or fits). </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;fits&#39;</span><span class="p">]:</span> 
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot; Unsupported filename: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">]:</span> 
            <span class="c1"># import imageio</span>
            <span class="kn">import</span> <span class="nn">imageio.v2</span> <span class="k">as</span> <span class="nn">imageio</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> 
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">/</span><span class="mf">255.0</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="kc">None</span> 
            <span class="k">except</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">hdr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;fits&#39;</span><span class="p">:</span> 
            <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="n">ihdu</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">ihdu</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
                <span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">hdr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">img</span><span class="p">,</span> <span class="n">hdr</span><span class="p">]</span></div>

<div class="viewcode-block" id="mockimg.readimgs"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.readimgs">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">readimgs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">ihdu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aslist</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">):</span> 
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        load all the images and convert them into a tensor (indx, xpix, ypix, 1).  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">hdrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inputfile</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span> 
            <span class="n">img_</span><span class="p">,</span> <span class="n">hdr_</span> <span class="o">=</span> <span class="n">mockimg</span><span class="o">.</span><span class="n">readimg_worker</span><span class="p">(</span><span class="n">inputfile</span><span class="p">,</span> <span class="n">ihdu</span> <span class="o">=</span> <span class="n">ihdu</span><span class="p">)</span> 
            <span class="n">imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_</span><span class="p">)</span>
            <span class="n">hdrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdr_</span><span class="p">)</span>
            
        <span class="c1"># print(&#39;### Finish reading %i files&#39;%(len(inputs)))</span>
        <span class="k">if</span> <span class="n">aslist</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> 
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">):</span> <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span> <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,</span> <span class="p">:]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;###-----------------------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;### The shape of image array = &#39;</span><span class="p">,</span> <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">hdrs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;###-----------------------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;### return as list&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">hdrs</span></div>


<div class="viewcode-block" id="mockimg.ruv2xyz"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.ruv2xyz">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">ruv2xyz</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">v</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">u</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">v</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">u</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span></div>

<div class="viewcode-block" id="mockimg.xyz2ruv"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.xyz2ruv">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">xyz2ruv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>  
        <span class="n">r</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">;</span>   
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span></div>

<div class="viewcode-block" id="mockimg.autowcs"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.autowcs">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">autowcs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">pixscale</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">enlarge</span> <span class="o">=</span> <span class="mf">1.01</span><span class="p">):</span> 
        <span class="n">a_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">a</span><span class="p">)])</span>
        <span class="n">d_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">d</span><span class="p">)])</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">mockimg</span><span class="o">.</span><span class="n">ruv2xyz</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">a_</span><span class="p">,</span> <span class="n">d_</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span><span class="n">a0</span><span class="p">,</span><span class="n">d0</span> <span class="o">=</span> <span class="n">mockimg</span><span class="o">.</span><span class="n">xyz2ruv</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">z0</span><span class="p">)</span>
        <span class="n">obj0</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">d0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">obj</span>  <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">a</span><span class="p">,</span>  <span class="n">d</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">sep</span>  <span class="o">=</span> <span class="n">obj0</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">degree</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span><span class="o">*</span><span class="n">enlarge</span>
        <span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>
        <span class="n">alpha_center</span> <span class="o">=</span> <span class="n">a0</span><span class="p">;</span> <span class="n">NAXIS1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="n">pixscale</span><span class="p">);</span> <span class="n">xpix_center</span>  <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="p">(</span><span class="n">NAXIS1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="p">;</span>  
        <span class="n">delta_center</span> <span class="o">=</span> <span class="n">d0</span><span class="p">;</span> <span class="n">NAXIS2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="n">pixscale</span><span class="p">);</span> <span class="n">ypix_center</span>  <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="p">(</span><span class="n">NAXIS2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="p">;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">naxis</span><span class="o">=</span><span class="mi">2</span><span class="p">);</span>  
        <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cd</span>    <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="n">pixscale</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rho</span><span class="p">),</span> <span class="n">pixscale</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rho</span><span class="p">)],</span> 
                       <span class="p">[</span> <span class="n">pixscale</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rho</span><span class="p">),</span> <span class="n">pixscale</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rho</span><span class="p">)]]</span>
        <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">ctype</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RA---TAN&#39;</span><span class="p">,</span> <span class="s1">&#39;DEC--TAN&#39;</span><span class="p">]</span>
        <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crval</span> <span class="o">=</span> <span class="p">[</span><span class="n">alpha_center</span><span class="p">,</span> <span class="n">delta_center</span><span class="p">]</span> 
        <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span> <span class="o">=</span> <span class="p">[</span> <span class="n">xpix_center</span><span class="p">,</span>  <span class="n">ypix_center</span><span class="p">]</span>
        <span class="n">w</span><span class="o">.</span><span class="n">pixel_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">NAXIS1</span><span class="p">,</span> <span class="n">NAXIS2</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#--- autowcs by input coordinates&#39;</span><span class="p">)</span> 
        <span class="nb">print</span><span class="p">()</span>
        <span class="c1"># print(&#39;#--- pixscale = %f degree/pixel&#39;%pixscale )</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">w</span></div>

<div class="viewcode-block" id="mockimg.isinBOX"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.isinBOX">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">isinBOX</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">old_rec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        box: array_like</span>
<span class="sd">             box_xmin, box_ymin, box_xmax, box_ymax</span>
<span class="sd">        old_rec: array_like, shape = [4, :]</span>
<span class="sd">             old rectangle, xmin, ymin, xmax, ymax</span>
<span class="sd">        return: </span>
<span class="sd">        indx: array_like, bool</span>
<span class="sd">              x == -1, no corner in the box; </span>
<span class="sd">              x ==  0, all corners fully in the box </span>
<span class="sd">              x ==  1, left  bottom corner in the box</span>
<span class="sd">              x ==  2, right bottom corner in the box</span>
<span class="sd">              x ==  3, right upper  corner in the box</span>
<span class="sd">              x ==  4, left  upper  corner in the box</span>
<span class="sd">        new_rec: array_like, shape = [4, :] </span>
<span class="sd">             new rectangle of joint region, xmin, ymin, xmax, ymax</span>
<span class="sd">        #-------------------------------------------------------</span>
<span class="sd">        #                          +------------(jxmax,jymax)</span>
<span class="sd">        #                          |                  |   </span>
<span class="sd">        #                +---------|--(ixmax,iymax)   |   xmin = max( ixmin, jxmin )</span>
<span class="sd">        #                |         |        |         |   ymin = max( iymin, jymin )</span>
<span class="sd">        #            height  (jxmin,jymin)------------+  </span>
<span class="sd">        #                |                  |             xmax = min( ixmax, jxmax )</span>
<span class="sd">        #      (ixmin,iymin)---- width -----+             ymax = min( iymax, jymax )</span>
<span class="sd">        #       </span>
<span class="sd">        #       if (xmax &gt; xmin)&amp;(ymax &gt; ymin):  is  in the box </span>
<span class="sd">        #       if (xmax &lt; xmin)|(ymax &lt; ymin):  not in the box </span>
<span class="sd">        #-------------------------------------------------------</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">old_rec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ixmin</span><span class="p">,</span> <span class="n">iymin</span><span class="p">,</span> <span class="n">ixmax</span><span class="p">,</span> <span class="n">iymax</span> <span class="o">=</span> <span class="n">box</span> 
        <span class="n">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">,:][</span> <span class="n">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">&lt;</span> <span class="n">ixmin</span> <span class="p">]</span> <span class="o">=</span> <span class="n">ixmin</span> 
        <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">,:][</span> <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">&lt;</span> <span class="n">iymin</span> <span class="p">]</span> <span class="o">=</span> <span class="n">iymin</span>
        <span class="n">rec</span><span class="p">[</span><span class="mi">2</span><span class="p">,:][</span> <span class="n">rec</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">&gt;</span> <span class="n">ixmax</span> <span class="p">]</span> <span class="o">=</span> <span class="n">ixmax</span> 
        <span class="n">rec</span><span class="p">[</span><span class="mi">3</span><span class="p">,:][</span> <span class="n">rec</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">&gt;</span> <span class="n">iymax</span> <span class="p">]</span> <span class="o">=</span> <span class="n">iymax</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">old_rec</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">&lt;=</span> <span class="n">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span><span class="o">|</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">&lt;=</span> <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">,:])</span>
        <span class="k">return</span> <span class="o">~</span><span class="n">indx</span><span class="p">,</span> <span class="n">rec</span></div>

<div class="viewcode-block" id="mockimg.fillin"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.fillin">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fillin</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">stps</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">return_fill</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">):</span> 
        <span class="n">ngal</span> <span class="o">=</span>  <span class="nb">len</span><span class="p">(</span><span class="n">xc</span><span class="p">)</span>
        <span class="n">xs</span>   <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">stp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">stp</span> <span class="ow">in</span> <span class="n">stps</span><span class="p">]</span> <span class="p">)</span> 
        <span class="n">ys</span>   <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">stp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">stp</span> <span class="ow">in</span> <span class="n">stps</span><span class="p">]</span> <span class="p">)</span> 
        <span class="n">ori_rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xc</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">xs</span><span class="p">,</span> <span class="n">yc</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">ys</span><span class="p">,</span> <span class="n">xc</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">xs</span><span class="p">,</span> <span class="n">yc</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">ys</span><span class="p">]</span> <span class="p">)</span> 
        <span class="n">img_rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">])</span> 
        <span class="n">indx</span><span class="p">,</span> <span class="n">stp_rec</span> <span class="o">=</span> <span class="n">mockimg</span><span class="o">.</span><span class="n">isinBOX</span><span class="p">(</span><span class="n">img_rec</span><span class="p">,</span> <span class="n">ori_rec</span><span class="p">)</span> 
        <span class="c1">#----------------------------------------------------------------</span>
        <span class="n">ori_rec</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ori_rec</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">);</span> 
        <span class="n">stp_rec</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stp_rec</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">);</span> 
        <span class="n">img_rec</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_rec</span> <span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">);</span> 
        <span class="n">fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">ngal</span><span class="p">)</span> <span class="p">)</span>  <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ngal</span><span class="p">):</span> 
            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span>   <span class="o">=</span> <span class="n">stp_rec</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">xref</span><span class="p">,</span> <span class="n">yref</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ori_rec</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">x0_</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">xref</span>
            <span class="n">x1_</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">xref</span>
            <span class="n">y0_</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">yref</span>
            <span class="n">y1_</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">yref</span>
            <span class="k">if</span> <span class="n">indx</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span> <span class="n">fill</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x0_</span><span class="p">,</span> <span class="n">y0_</span><span class="p">,</span> <span class="n">x1_</span><span class="p">,</span> <span class="n">y1_</span> <span class="p">]</span>
            <span class="k">if</span> <span class="n">indx</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span> <span class="n">img</span><span class="p">[</span><span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stps</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">y0_</span><span class="p">:</span><span class="n">y1_</span><span class="p">,</span> <span class="n">x0_</span><span class="p">:</span><span class="n">x1_</span><span class="p">]</span> 
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">fill</span></div>

<div class="viewcode-block" id="mockimg.download_from_desidr9"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.download_from_desidr9">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">download_from_desidr9</span><span class="p">():</span>
        <span class="k">pass</span></div>
    
<div class="viewcode-block" id="mockimg.wcs2hdu"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.wcs2hdu">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">wcs2hdu</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="n">NAXIS1</span><span class="p">,</span> <span class="n">NAXIS2</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">pixel_shape</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">NAXIS2</span><span class="p">,</span> <span class="n">NAXIS1</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">img</span><span class="p">);</span> 
        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="n">w</span><span class="o">.</span><span class="n">to_header</span><span class="p">())</span> 
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">hdr</span></div>

<div class="viewcode-block" id="mockimg.save_as_fits"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.save_as_fits">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">save_as_fits</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">outputname</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">hdr</span><span class="p">):</span> 
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span> <span class="n">img</span> <span class="p">);</span> 
        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">hdr</span>
        <span class="n">hdul</span><span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(),</span> <span class="n">hdu</span><span class="p">])</span>
        <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span> <span class="n">outputname</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span>  <span class="kc">True</span><span class="p">)</span>
        <span class="n">hdul</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="mockimg.save_as_jpeg"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.save_as_jpeg">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">save_as_jpeg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;jpeg&#39;</span><span class="p">:</span> 
            <span class="kn">import</span> <span class="nn">imageio</span>
            <span class="n">imageio</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> </div>
    
<div class="viewcode-block" id="mockimg.wcs2reg"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.wcs2reg">[docs]</a>    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">wcs2reg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">npt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">return_world</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">):</span> 
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Input: w, wcs object of astropy.wcs</span>
<span class="sd">        npt = 1 # Number of elements for each side of the pixel.</span>
<span class="sd">        Return: </span>
<span class="sd">           The profile in the celestial coordinate system (ra, dec). </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">npt</span>   <span class="o">=</span> <span class="n">npt</span> <span class="o">+</span> <span class="mi">1</span> 
        <span class="n">nxpix</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">pixel_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nypix</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">pixel_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nxrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nxpix</span><span class="p">,</span> <span class="n">npt</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">nyrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nypix</span><span class="p">,</span> <span class="n">npt</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">xbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span> <span class="n">nxrange</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span>       <span class="p">[</span><span class="n">nxrange</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="p">(</span><span class="n">npt</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>   <span class="n">nxrange</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>     <span class="p">[</span><span class="n">nxrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="p">(</span><span class="n">npt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">]</span> <span class="p">)</span><span class="c1">#.astype( int )</span>
        <span class="n">ybox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([[</span><span class="n">nyrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="p">(</span><span class="n">npt</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>   <span class="n">nyrange</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span>         <span class="p">[</span><span class="n">nyrange</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="p">(</span><span class="n">npt</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">nyrange</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span><span class="c1">#.astype( int )</span>
        <span class="k">if</span> <span class="n">return_world</span><span class="p">:</span> 
            <span class="n">ra_box</span><span class="p">,</span> <span class="n">dec_box</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span><span class="n">xbox</span><span class="p">,</span> <span class="n">ybox</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> 
            <span class="k">return</span> <span class="n">ra_box</span><span class="p">,</span> <span class="n">dec_box</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">xbox</span><span class="p">,</span> <span class="n">ybox</span></div>
<div class="viewcode-block" id="mockimg.downloads"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.downloads">[docs]</a>    <span class="nd">@classmethod</span>  
    <span class="k">def</span> <span class="nf">downloads</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="s1">&#39;./__cache__/&#39;</span><span class="p">,</span> <span class="n">as_shell</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">survey</span> <span class="o">=</span> <span class="s1">&#39;desi&#39;</span><span class="p">,</span> <span class="n">pixscale</span><span class="o">=</span><span class="mf">0.262</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="n">bands</span> <span class="o">=</span> <span class="s1">&#39;grz&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;desi&#39;</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">pixscale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pixscale</span> <span class="o">=</span> <span class="mf">0.262</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">];</span>
        
        <span class="n">outputnames</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="k">if</span> <span class="n">as_shell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">as_shell</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">):</span>
            <span class="n">a_</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">d_</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">outputname</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span><span class="o">%</span><span class="n">ii</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>
            <span class="k">if</span>  <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outputname</span><span class="p">))</span> <span class="p">:</span> 
                <span class="k">pass</span>
                <span class="c1">#print(&#39;&quot;%s&quot; exists&#39;%outputname) </span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">suffix</span><span class="o">!=</span><span class="s1">&#39;jpeg&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">suffix</span><span class="o">!=</span><span class="s1">&#39;fits&#39;</span><span class="p">):</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Suffix of outputname &quot;</span><span class="si">%s</span><span class="s1">&quot; is not correct. &#39;</span><span class="o">%</span><span class="n">outputname</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Suffix should be &quot;jpeg&quot; or &quot;fits&quot;&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  
                <span class="c1"># os.system(&#39;rm -rf %s&#39;%outputname)</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;wget -O </span><span class="si">%s</span><span class="s1"> --no-check-certificate &#39;</span><span class="o">%</span> <span class="n">outputname</span>
                <span class="n">web</span> <span class="o">=</span> <span class="s1">&#39; &quot;https://www.legacysurvey.org/viewer/</span><span class="si">%s</span><span class="s1">-cutout?ra=</span><span class="si">%f</span><span class="s1">&amp;dec=</span><span class="si">%f</span><span class="s1">&amp;height=</span><span class="si">%s</span><span class="s1">&amp;width=</span><span class="si">%s</span><span class="s1">&amp;layer=ls-dr9&amp;pixscale=</span><span class="si">%s</span><span class="s1">&amp;bands=</span><span class="si">%s</span><span class="s1">&quot; &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">a_</span><span class="p">,</span> <span class="n">d_</span><span class="p">,</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pixscale</span><span class="p">,</span> <span class="n">bands</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">as_shell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
                    <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">([</span><span class="n">cmd</span> <span class="o">+</span> <span class="n">web</span> <span class="o">+</span> <span class="s1">&#39; </span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">])</span> 
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="n">cmd</span> <span class="o">+</span> <span class="n">web</span><span class="p">)</span>
            <span class="n">outputnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outputname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">as_shell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  
        <span class="k">return</span> <span class="n">outputnames</span></div>
    
<div class="viewcode-block" id="mockimg.easy_bkg"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.easy_bkg">[docs]</a>    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">easy_bkg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span> 
        <span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clipped_stats</span><span class="p">,</span> <span class="n">SigmaClip</span>
        <span class="kn">from</span> <span class="nn">photutils.segmentation</span> <span class="kn">import</span> <span class="n">detect_threshold</span><span class="p">,</span> <span class="n">detect_sources</span>
        <span class="kn">from</span> <span class="nn">photutils.utils</span> <span class="kn">import</span> <span class="n">circular_footprint</span>
        <span class="n">sigma_clip</span>  <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">threshold</span>   <span class="o">=</span> <span class="n">detect_threshold</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">)</span>
        <span class="n">segment_img</span> <span class="o">=</span> <span class="n">detect_sources</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">footprint</span> <span class="o">=</span> <span class="n">circular_footprint</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">segment_img</span><span class="o">.</span><span class="n">make_source_mask</span><span class="p">(</span><span class="n">footprint</span><span class="o">=</span><span class="n">footprint</span><span class="p">)</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span></div>
<div class="viewcode-block" id="mockimg.rgb"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.rgb">[docs]</a>    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">survey</span> <span class="o">=</span> <span class="s1">&#39;desi&#39;</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">photutils.segmentation</span> <span class="kn">import</span> <span class="n">detect_threshold</span><span class="p">,</span> <span class="n">detect_sources</span><span class="p">,</span> <span class="n">deblend_sources</span><span class="p">,</span> <span class="n">SourceCatalog</span>
        <span class="n">image_r</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">bkg_r</span><span class="p">,</span> <span class="n">std_r</span> <span class="o">=</span> <span class="n">mockimg</span><span class="o">.</span><span class="n">easy_bkg</span><span class="p">(</span><span class="n">image_r</span><span class="p">);</span> 
        <span class="n">image_g</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">bkg_g</span><span class="p">,</span> <span class="n">std_g</span> <span class="o">=</span> <span class="n">mockimg</span><span class="o">.</span><span class="n">easy_bkg</span><span class="p">(</span><span class="n">image_g</span><span class="p">);</span> 
        <span class="n">image_b</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="n">bkg_b</span><span class="p">,</span> <span class="n">std_b</span> <span class="o">=</span> <span class="n">mockimg</span><span class="o">.</span><span class="n">easy_bkg</span><span class="p">(</span><span class="n">image_b</span><span class="p">);</span> 
        <span class="n">r</span> <span class="o">=</span> <span class="n">image_r</span> <span class="o">-</span> <span class="n">bkg_r</span><span class="c1">#/std_r</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">image_g</span> <span class="o">-</span> <span class="n">bkg_g</span><span class="c1">#/std_g</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">image_b</span> <span class="o">-</span> <span class="n">bkg_b</span><span class="c1">#/std_b</span>
        <span class="c1"># 4.9,5.7,7.8 </span>
        <span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">SqrtStretch</span>
        <span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">ZScaleInterval</span>
        <span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">make_lupton_rgb</span>
        <span class="c1"># lo_val, up_val = np.percentile(np.hstack((r.flatten(), g.flatten(), b.flatten())), (0.05, 99.5)) </span>
        <span class="k">if</span> <span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;desi&#39;</span><span class="p">:</span> 
            <span class="n">image</span> <span class="o">=</span> <span class="n">make_lupton_rgb</span><span class="p">(</span><span class="mf">0.7</span><span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="mf">1.1</span><span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="mf">1.8</span><span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">minimum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">image</span> <span class="o">=</span> <span class="n">make_lupton_rgb</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">/</span><span class="mi">255</span>
        <span class="k">return</span> <span class="n">image</span></div>
    
<div class="viewcode-block" id="mockimg.run"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.utilsdev.mockimg.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ngal</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>  
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey</span> <span class="o">==</span> <span class="s1">&#39;desi&#39;</span><span class="p">:</span> <span class="n">pixscale</span> <span class="o">=</span> <span class="mf">0.262</span><span class="o">/</span><span class="mi">3600</span><span class="p">;</span> <span class="n">rho</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">mockimg</span><span class="o">.</span><span class="n">autowcs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">],</span> 
                                       <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">],</span> 
                                        <span class="n">pixscale</span> <span class="o">=</span> <span class="n">pixscale</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">enlarge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enlarge</span> <span class="p">)</span>
            
        <span class="c1">#--- 预处理 </span>
        <span class="n">img</span><span class="p">,</span> <span class="n">hdr</span> <span class="o">=</span> <span class="n">mockimg</span><span class="o">.</span><span class="n">wcs2hdu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span> 
        <span class="n">stprgbs</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stps</span>
        <span class="nb">print</span><span class="p">()</span> 
        <span class="n">nchannel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stprgbs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nchannel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#--- Run as single channel&#39;</span><span class="p">)</span>  
        <span class="k">if</span> <span class="n">nchannel</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#--- Run as </span><span class="si">%s</span><span class="s1"> channel&#39;</span><span class="o">%</span><span class="n">nchannel</span> <span class="p">)</span> 
        <span class="n">imgrgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">img</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchannel</span><span class="p">)])</span> 
        <span class="n">mskrgb</span> <span class="o">=</span> <span class="n">imgrgb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="mf">0.0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">xc</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">yc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> 
        <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchannel</span><span class="p">):</span> 
        <span class="c1">#--- 确定图像的区域（Imaging strategy）</span>
            <span class="n">img</span>      <span class="o">=</span> <span class="n">imgrgb</span><span class="p">[</span><span class="n">nc</span><span class="p">]</span>
            <span class="n">img_msk</span>  <span class="o">=</span> <span class="n">mskrgb</span><span class="p">[</span><span class="n">nc</span><span class="p">]</span>
        <span class="c1">#--- 准备需要的子图（prepare stamps &amp; Locations） </span>
            <span class="n">stps</span>    <span class="o">=</span> <span class="n">stprgbs</span><span class="p">[</span><span class="n">nc</span><span class="p">]</span>            
            <span class="n">stp_msks</span><span class="o">=</span> <span class="p">[</span><span class="n">stp</span><span class="o">*</span><span class="mi">0</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">stp</span> <span class="ow">in</span> <span class="n">stps</span><span class="p">]</span>
        <span class="c1">#--- 抽取目标和背景(extract object mask &amp; background noise)</span>
            <span class="n">noises</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">stp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stps</span><span class="p">):</span>
                <span class="n">stp_msk</span><span class="p">,</span> <span class="n">bkg_msk</span> <span class="o">=</span> <span class="n">sex</span><span class="p">(</span><span class="n">stp</span><span class="p">)</span><span class="o">.</span><span class="n">return_mainobj</span><span class="p">()</span> 
                <span class="n">stp_msks</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">stp_msk</span>
                <span class="n">noises</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stp</span><span class="p">[</span><span class="n">bkg_msk</span><span class="p">])</span> 
                <span class="n">stps</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">~</span><span class="n">stp_msk</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 

            <span class="n">noises</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">noises</span><span class="p">)</span> 
            
        <span class="c1">#--- 叠加准备的子图（stamp superposition）</span>
            <span class="n">img</span><span class="p">,</span>     <span class="n">fill</span><span class="o">=</span> <span class="n">mockimg</span><span class="o">.</span><span class="n">fillin</span><span class="p">(</span><span class="n">img</span><span class="p">,</span>     <span class="n">stps</span><span class="p">,</span>     <span class="bp">self</span><span class="o">.</span><span class="n">xc</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">yc</span><span class="p">)</span>
            <span class="n">img_msk</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span> <span class="n">mockimg</span><span class="o">.</span><span class="n">fillin</span><span class="p">(</span><span class="n">img_msk</span><span class="p">,</span> <span class="n">stp_msks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">yc</span><span class="p">)</span> 
        <span class="c1">#--- 添加背景噪声（background noise)</span>
            <span class="n">n_fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">fill</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
            <span class="n">n_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">img_msk</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_fill</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> 
                <span class="n">img</span><span class="p">[</span><span class="n">img_msk</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span> <span class="n">noises</span><span class="p">,</span> <span class="n">n_noise</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">imgrgb</span><span class="p">[</span><span class="n">nc</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
            <span class="n">mskrgb</span><span class="p">[</span><span class="n">nc</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_msk</span>
        <span class="k">if</span> <span class="n">nchannel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
            <span class="n">imgrgb</span> <span class="o">=</span> <span class="n">imgrgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mskrgb</span> <span class="o">=</span> <span class="n">mskrgb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nchannel</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> 
            <span class="n">imgrgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">imgrgb</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> 
            <span class="n">mskrgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">mskrgb</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#--- return shape:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">imgrgb</span><span class="p">)</span> <span class="p">)</span> 
        <span class="k">return</span> <span class="n">imgrgb</span><span class="p">,</span> <span class="n">mskrgb</span><span class="p">,</span> <span class="n">hdr</span></div></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, 0.0.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>