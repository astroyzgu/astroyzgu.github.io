<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>csstmock.utils.fiberassign &mdash; csstmock 0.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            csstmock
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../online-readme/online-readme.html">online-readme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../online-documents.html">online documents</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">csstmock</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changes.html">Change Log</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">csstmock</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">csstmock.utils.fiberassign</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for csstmock.utils.fiberassign</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">join_skycoord</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">KDTree</span>

<span class="kn">import</span> <span class="nn">csstmock.utils</span> <span class="k">as</span> <span class="nn">utils</span> 
<div class="viewcode-block" id="quickfa1pass"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.fiberassign.quickfa1pass">[docs]</a><span class="k">def</span> <span class="nf">quickfa1pass</span><span class="p">(</span><span class="n">ra_tgt</span><span class="p">,</span> <span class="n">dec_tgt</span><span class="p">,</span> <span class="n">ra_fib</span><span class="p">,</span> <span class="n">dec_fib</span><span class="p">,</span> <span class="n">rsearch</span><span class="p">,</span> <span class="n">mask_tgt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">subpriority</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">finetune</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    quick fiberassign </span>
<span class="sd">    parameter</span>
<span class="sd">    ===========</span>
<span class="sd">    ra_tgt, dec_tgt: array-like </span>
<span class="sd">        coordinates of targets  </span>
<span class="sd">    ra_fib, dec_fib: list of array-like </span>
<span class="sd">        coordinates of pointing centers of robotic fibers. </span>
<span class="sd">    rsearch: float </span>
<span class="sd">        search radius in degee </span>
<span class="sd">    subpriority: array-like</span>
<span class="sd">        subpriority of each targets</span>
<span class="sd">    mask_tgt: array-like </span>
<span class="sd">        False (or 0), waiting to be assigned; True (or 1), masked; </span>
<span class="sd">    </span>
<span class="sd">    return</span>
<span class="sd">    =========== </span>
<span class="sd">    ifiber: array-like</span>
<span class="sd">        ifiber &gt;= 0, fiber id at that round be assigned. </span>
<span class="sd">        ifiber = -1, galaxies which are not assigned. </span>
<span class="sd">        ifiber = -2, galaxies which are not reachable. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">xyztgt</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ruv2xyz</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ra_tgt</span><span class="p">,</span> <span class="n">dec_tgt</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
    <span class="n">xyzfib</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ruv2xyz</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ra_fib</span><span class="p">,</span> <span class="n">dec_fib</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
    <span class="n">sep3d</span>  <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rsearch</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1"># &gt;&gt;&gt; 换为直线距离</span>

    <span class="n">ntgt</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">xyztgt</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="c1"># 目标的总数量</span>
    <span class="n">nfib</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">xyzfib</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="c1"># 光纤的总数量</span>
    <span class="k">if</span> <span class="n">mask_tgt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">mask_tgt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntgt</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">mask_tgt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask_tgt</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">itgt</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntgt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> 
    <span class="n">ifib</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntgt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> 

    <span class="c1"># 查看每一个光纤搜索半径内星系的数目ngal_per_fib和编号itgt_per_fib</span>
    <span class="n">kd</span>            <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">xyztgt</span><span class="p">)</span>

    <span class="c1">#--- ntgt_per_fib = kd.query_ball_point(xyzfib, r = sep3d, return_length = True)</span>
    <span class="n">itgt_per_fib</span> <span class="o">=</span> <span class="n">kd</span><span class="o">.</span><span class="n">query_ball_point</span><span class="p">(</span><span class="n">xyzfib</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">sep3d</span><span class="p">,</span> <span class="n">return_sorted</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">itgt_avail</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">itgt_per_fib</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> 
    <span class="n">itgt</span><span class="p">[</span><span class="n">itgt_avail</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">ifib</span><span class="p">[</span><span class="n">itgt_avail</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1">#--- 为每一个光纤完全随机的指派一个星系</span>
    <span class="k">if</span> <span class="n">subpriority</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">subpriority</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ntgt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fibid_</span><span class="p">,</span> <span class="n">tgtid_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itgt_per_fib</span><span class="p">):</span>
        <span class="n">tgtid_</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tgtid_</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tgtid_</span><span class="p">)</span><span class="o">==</span> <span class="mi">0</span><span class="p">:</span>   <span class="k">continue</span> 
        
        <span class="n">mask_tgt_</span>     <span class="o">=</span> <span class="n">mask_tgt</span><span class="p">[</span><span class="n">tgtid_</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">mask_tgt_</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>  <span class="k">continue</span>

        <span class="n">tgtid_</span>        <span class="o">=</span> <span class="n">tgtid_</span><span class="p">[</span><span class="o">~</span><span class="n">mask_tgt_</span><span class="p">]</span> 
        <span class="n">subpriority_</span>  <span class="o">=</span> <span class="n">subpriority</span><span class="p">[</span><span class="n">tgtid_</span><span class="p">]</span>
        <span class="n">tgtid_</span>        <span class="o">=</span> <span class="n">tgtid_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">subpriority_</span><span class="p">)</span> <span class="o">==</span> <span class="n">subpriority_</span><span class="p">]</span>
        <span class="n">tgtid_</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">tgtid_</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">itgt</span><span class="p">[</span><span class="n">tgtid_</span><span class="p">]</span>  <span class="o">=</span> <span class="n">tgtid_</span>
        <span class="n">ifib</span><span class="p">[</span><span class="n">tgtid_</span><span class="p">]</span>  <span class="o">=</span> <span class="n">fibid_</span>

    <span class="k">return</span> <span class="n">itgt</span><span class="p">,</span> <span class="n">ifib</span></div>
    <span class="c1">#--- finetune 查看有没有其他光纤有能力指向这个星系 </span>
    <span class="c1"># itgt_assign, time_assign = np.unique(itgt[itgt&gt;=0], return_counts=True) </span>
    <span class="c1"># itgt_finetune = itgt_assign[time_assign &gt;= 2] </span>
    <span class="c1"># indx_finetune = np.isin(itgt, itgt_finetune) </span>
    <span class="c1"># ifib_finetune = ifib[indx_finetune] </span>
    <span class="c1"># ntgt_per_fib[ifib_finetune]</span>
                <span class="c1"># #--- 查看有没有其他光纤有能力指向这个星系 </span>
                <span class="c1"># if (t1[&#39;ngal_of_fib&#39;][galid_final] == -1)|(ngal_per_fib_[fibid] &lt; t1[&#39;ngal_of_fib&#39;][galid_final]): </span>
                <span class="c1">#     # 1. 如果这个星系还没有安排上光纤， 那先安排上； 后面在遍历所有光纤时，如果有其他光纤也指向了这个星系，则转入2。 </span>
                <span class="c1">#     # 2. 如果当前光纤搜索半径内星系的数目较少， 这优先用这根光纤。</span>
                <span class="c1">#     t1[&#39;ifiber&#39;][galid_final]      = ifib_[fibid]</span>
                <span class="c1">#     t1[&#39;ngal_of_fib&#39;][galid_final] = ngal_per_fib_[fibid]</span>
                <span class="c1"># t1[&#39;iround&#39;][galid_final] = iround__</span>





<div class="viewcode-block" id="quickfa"><a class="viewcode-back" href="../../../csstmock.utils.html#csstmock.utils.fiberassign.quickfa">[docs]</a><span class="k">def</span> <span class="nf">quickfa</span><span class="p">(</span><span class="n">xyztgt</span><span class="p">,</span> <span class="n">xyzfib</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mf">1.48</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">xyz</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    quick fiberassign </span>
<span class="sd">    parameter: </span>
<span class="sd">    xyztgt: array-like </span>
<span class="sd">        coordinates of galaxy </span>
<span class="sd">    xyzfib: array-like </span>
<span class="sd">        coordinates of  fiber</span>
<span class="sd">    r: search radius in degee </span>
<span class="sd">    xyz: if xyz is True:  coordinates means x,y,z.</span>
<span class="sd">         if xyz is False: coordinates means r,u,v.</span>
<span class="sd">    return: iround, ifiber </span>

<span class="sd">    iround &gt;= 0, round id be assigned. nround == 1 means that the galaxy is assigned in 2nd round. </span>
<span class="sd">    iround = -1, not assigned. </span>
<span class="sd">    iround = -2, galaxies which fiber is impossible to point to.</span>
<span class="sd">    </span>
<span class="sd">    ifiber &gt;= 0, fiber id at that round be assigned. </span>
<span class="sd">    ifiber = -1, galaxies which are not assigned. </span>
<span class="sd">    ifiber = -2, galaxies which are not assigned. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span> 
    <span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="c1"># 定义日志记录器，并将以上两者添加到记录器中</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span> <span class="c1"># &#39;mylogger&#39;)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xyz</span><span class="p">:</span> 
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">x</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xyztgt</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xyztgt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xyztgt</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xyztgt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xyztgt</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">xyztgt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">iround_</span><span class="p">,</span> <span class="n">xyzfib_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyzfib</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xyzfib_</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xyzfib_</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xyzfib_</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xyzfib_</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xyzfib_</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">180.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">xyzfib</span><span class="p">[</span><span class="n">iround_</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>



    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s1">&#39;Search radius of each fiber positioner is </span><span class="si">%s</span><span class="s1"> deg.&#39;</span><span class="o">%</span> <span class="n">r</span> <span class="p">)</span> 
    <span class="n">rsearch</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">r</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1"># &gt;&gt;&gt; 换为直线距离</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
    <span class="n">ngal</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">xyztgt</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="c1"># 总的星系数量</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s1">&#39;Normalizing input positions of </span><span class="si">%s</span><span class="s1"> targets.&#39;</span><span class="o">%</span> <span class="n">ngal</span> <span class="p">)</span> 
    <span class="n">rgal</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xyztgt</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s1">&#39;Normalizing positions of fiber positioner.&#39;</span><span class="p">)</span> 
    <span class="n">xyztgt</span> <span class="o">=</span> <span class="n">xyztgt</span><span class="o">/</span><span class="n">rgal</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nround</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="n">nfiber</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iround_</span><span class="p">,</span> <span class="n">xyzfib_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyzfib</span><span class="p">):</span>
        <span class="n">nfib_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">xyzfib</span><span class="p">[</span><span class="n">iround_</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s1">&#39; - SET </span><span class="si">%s</span><span class="s1"> has </span><span class="si">%s</span><span class="s1"> fiber positioners&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">iround_</span><span class="p">,</span> <span class="n">nfib_</span><span class="p">)</span> <span class="p">)</span> 
        <span class="n">rfib_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xyzfib_</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">xyzfib</span><span class="p">[</span><span class="n">iround_</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyzfib_</span><span class="o">/</span><span class="n">rfib_</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">nround</span> <span class="o">=</span> <span class="n">nround</span> <span class="o">+</span> <span class="mi">1</span> 
        <span class="n">nfiber</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nfib_</span><span class="p">)</span> 



    <span class="n">t1</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span> 
    <span class="n">t1</span><span class="p">[</span><span class="s1">&#39;igal&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngal</span><span class="p">)</span> <span class="c1"># 给输入星系编号</span>
    <span class="n">t1</span><span class="p">[</span><span class="s1">&#39;iround&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>             <span class="c1"># 在哪一轮观测到？</span>
    <span class="n">t1</span><span class="p">[</span><span class="s1">&#39;ifiber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>             <span class="c1"># 安排了哪一个光纤? </span>
    <span class="n">t1</span><span class="p">[</span><span class="s1">&#39;ngal_of_fib&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># 安排了光纤，它搜索范围内星系的数目</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    找到不在光纤搜索范围内的星系。 </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">index_avail</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iround_</span><span class="p">,</span> <span class="n">xyzfib_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyzfib</span><span class="p">):</span>
        <span class="n">kd_fib_</span>        <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">xyzfib_</span><span class="p">);</span>
        <span class="n">nfib_per_gal_</span>  <span class="o">=</span> <span class="n">kd_fib_</span><span class="o">.</span><span class="n">query_ball_point</span><span class="p">(</span><span class="n">xyztgt</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rsearch</span><span class="p">,</span>  <span class="n">return_length</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">index_avail</span><span class="p">[</span> <span class="n">nfib_per_gal_</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> 
    <span class="n">t1</span><span class="p">[</span><span class="s1">&#39;iround&#39;</span><span class="p">][</span><span class="n">index_avail</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">t1</span><span class="p">[</span><span class="s1">&#39;ifiber&#39;</span><span class="p">][</span><span class="n">index_avail</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">index_avail</span><span class="p">)</span> <span class="o">==</span> <span class="n">ngal</span><span class="p">:</span> 
        <span class="n">iround</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="s1">&#39;iround&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> 
        <span class="n">ifiber</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="s1">&#39;ifiber&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">iround</span><span class="p">,</span> <span class="n">ifiber</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    按轮次分配光纤给能够指向的星系 </span>
<span class="sd">    轮次：iround___；该轮光纤的搜索中心：xyzfib__；</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#--- starting the processes of fiber assignment&#39;</span><span class="p">)</span>
    <span class="c1">#--- bug: 如果星系同时在两个光纤的搜索半价内， 在同一轮观测中有可能两个光纤都指向了这个星系。</span>
    <span class="c1">#--- fix: 加入第二轮 istep == 1 （调整环节）, 如果两光纤都指向这个星系，优先安排光纤搜索范围内星系少的那根纤；剩下的光纤重新安排。  </span>
    <span class="k">for</span> <span class="n">iround__</span><span class="p">,</span> <span class="n">xyzfib__</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyzfib</span><span class="p">):</span> 
        <span class="n">nfib__</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">xyzfib__</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="c1"># 在这轮中光纤的数目            </span>
        <span class="n">ifib__</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nfib__</span><span class="p">);</span>     <span class="c1"># 给这轮中的光纤编号</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1">th set of fibers containing </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">iround__</span><span class="p">,</span> <span class="n">nfib__</span><span class="p">)</span> <span class="p">)</span> 
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;   - running...&#39;</span><span class="p">)</span> 
        <span class="c1">#print(&#39;#--- New round&#39;) </span>
        <span class="k">for</span> <span class="n">istep</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span> 
            <span class="c1"># 选出还没有使用的光纤</span>
            <span class="k">if</span> <span class="n">istep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">index_fib_</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nfib__</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">istep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;   - fine-tune...&#39;</span><span class="p">)</span> <span class="c1">#  %s &#39;% istep ) </span>

            <span class="n">ifib_</span>        <span class="o">=</span>   <span class="n">ifib__</span><span class="p">[</span><span class="n">index_fib_</span><span class="p">]</span> 
            <span class="n">xyzfib_</span>      <span class="o">=</span> <span class="n">xyzfib__</span><span class="p">[</span><span class="n">index_fib_</span><span class="p">]</span> 

            <span class="c1"># 选出还没有安排光纤的星系</span>
            <span class="n">indx_</span>   <span class="o">=</span> <span class="n">t1</span><span class="p">[</span><span class="s1">&#39;iround&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span> 
            <span class="n">igal_</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">t1</span><span class="p">[</span><span class="s1">&#39;igal&#39;</span><span class="p">][</span><span class="n">indx_</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> 
            <span class="n">xyztgt_</span> <span class="o">=</span> <span class="n">xyztgt</span><span class="p">[</span><span class="n">indx_</span><span class="p">]</span>

            <span class="c1"># 查看每一个光纤搜索半径内星系的数目ngal_per_fib</span>
            <span class="n">kd</span>            <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">xyztgt_</span><span class="p">)</span>
            <span class="n">ngal_per_fib_</span> <span class="o">=</span> <span class="n">kd</span><span class="o">.</span><span class="n">query_ball_point</span><span class="p">(</span><span class="n">xyzfib_</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rsearch</span><span class="p">,</span> <span class="n">return_length</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span>
            <span class="n">igal_per_fib_</span> <span class="o">=</span> <span class="n">kd</span><span class="o">.</span><span class="n">query_ball_point</span><span class="p">(</span><span class="n">xyzfib_</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rsearch</span><span class="p">,</span> <span class="n">return_sorted</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

            <span class="c1">#--- 为每一个光纤完全随机的指派一个星系</span>
            <span class="k">for</span> <span class="n">fibid</span><span class="p">,</span> <span class="n">galid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">igal_per_fib_</span><span class="p">):</span> 
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">galid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">galid</span>       <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">galid</span><span class="p">)</span>
                <span class="n">galid_final</span> <span class="o">=</span>  <span class="n">igal_</span><span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">galid</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

                <span class="c1">#--- 查看有没有其他光纤有能力指向这个星系 </span>
                <span class="k">if</span> <span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="s1">&#39;ngal_of_fib&#39;</span><span class="p">][</span><span class="n">galid_final</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">ngal_per_fib_</span><span class="p">[</span><span class="n">fibid</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="p">[</span><span class="s1">&#39;ngal_of_fib&#39;</span><span class="p">][</span><span class="n">galid_final</span><span class="p">]):</span> 
                    <span class="c1"># 1. 如果这个星系还没有安排上光纤， 那先安排上； 后面在遍历所有光纤时，如果有其他光纤也指向了这个星系，则转入2。 </span>
                    <span class="c1"># 2. 如果当前光纤搜索半径内星系的数目较少， 这优先用这根光纤。</span>
                    <span class="n">t1</span><span class="p">[</span><span class="s1">&#39;ifiber&#39;</span><span class="p">][</span><span class="n">galid_final</span><span class="p">]</span>      <span class="o">=</span> <span class="n">ifib_</span><span class="p">[</span><span class="n">fibid</span><span class="p">]</span>
                    <span class="n">t1</span><span class="p">[</span><span class="s1">&#39;ngal_of_fib&#39;</span><span class="p">][</span><span class="n">galid_final</span><span class="p">]</span> <span class="o">=</span> <span class="n">ngal_per_fib_</span><span class="p">[</span><span class="n">fibid</span><span class="p">]</span>
                <span class="n">t1</span><span class="p">[</span><span class="s1">&#39;iround&#39;</span><span class="p">][</span><span class="n">galid_final</span><span class="p">]</span> <span class="o">=</span> <span class="n">iround__</span>
            
            <span class="c1"># 选出还没有使用的光纤 </span>
            <span class="n">fibid_used_</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span> <span class="n">t1</span><span class="p">[</span><span class="s1">&#39;ifiber&#39;</span><span class="p">][(</span><span class="n">t1</span><span class="p">[</span><span class="s1">&#39;ifiber&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="s1">&#39;iround&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">iround__</span><span class="p">)]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">return_counts</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;    - </span><span class="si">%s</span><span class="s1">th set: Repeating fibers appear.&#39;</span> <span class="o">%</span> <span class="n">iround__</span> <span class="p">)</span>
            <span class="n">index_fib_</span><span class="p">[</span><span class="n">fibid_used_</span><span class="p">]</span>   <span class="o">=</span>  <span class="kc">False</span>
            <span class="n">ngal_unassigned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">t1</span><span class="p">[</span><span class="s1">&#39;ifiber&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> 
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;    - </span><span class="si">%s</span><span class="s1">th set: Used fibers  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">iround__</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="o">~</span><span class="n">index_fib_</span> <span class="p">)</span>  <span class="p">)</span> <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;    - </span><span class="si">%s</span><span class="s1">th set: Not assigned targets  </span><span class="si">%s</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1"> precent&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">iround__</span><span class="p">,</span> <span class="n">ngal_unassigned</span><span class="p">,</span>  <span class="mf">100.0</span><span class="o">*</span><span class="n">ngal_unassigned</span><span class="o">/</span><span class="n">ngal</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">iround</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="s1">&#39;iround&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ifiber</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="s1">&#39;ifiber&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">iround</span><span class="p">,</span> <span class="n">ifiber</span>            </div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, 0.0.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>