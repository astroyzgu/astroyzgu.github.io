<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>csstmock.dataio.io_jiutian &mdash; csstmock 0.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            csstmock
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../online-readme/online-readme.html">online-readme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../online-documents.html">online documents</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">csstmock</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changes.html">Change Log</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">csstmock</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">csstmock.dataio.io_jiutian</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for csstmock.dataio.io_jiutian</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This &quot;io_jiutian&quot; module is writen for extracting data from Jiutian simulation. </span>

<span class="sd">origin version: /home/cossim/Jiutian/M1000/code/python_script_for_hjx</span>

<span class="sd">Wirtten by Qingyang Li, Yizhou Gu (2023/11) </span>
<span class="sd">&#39;&#39;&#39;</span> 

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">jiutian_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;JIUTIAN_HOME&#39;</span><span class="p">)</span> 
<span class="k">if</span> <span class="n">jiutian_home</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">jiutian_home</span><span class="o">=</span><span class="s1">&#39;/home/cossim/Jiutian/&#39;</span>
    
<div class="viewcode-block" id="subhalo_filenum"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.subhalo_filenum">[docs]</a><span class="k">def</span> <span class="nf">subhalo_filenum</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">return_filelist</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">datadir</span> <span class="o">=</span> <span class="n">jiutian_home</span> <span class="o">+</span> <span class="s1">&#39;./M1000/hbt/&#39;</span><span class="p">):</span> 
    <span class="n">filename</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;SubSnap_</span><span class="si">%s</span><span class="s1">.*.hdf5&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">snapnum</span><span class="p">))</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">filelist</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filenum</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)):</span> 
        <span class="n">filename</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;SubSnap_</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.hdf5&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">filenum</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span> 
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; do not exist.&quot;</span><span class="o">%</span><span class="n">filename</span><span class="p">)</span>   
        <span class="n">filelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">return_filelist</span><span class="p">:</span> 
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span> <span class="n">filelist</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> </div>

<div class="viewcode-block" id="subhalo"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.subhalo">[docs]</a><span class="k">def</span> <span class="nf">subhalo</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">filenum</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">datadir</span> <span class="o">=</span> <span class="n">jiutian_home</span> <span class="o">+</span> <span class="s1">&#39;./M1000/hbt/&#39;</span><span class="p">):</span>
    <span class="n">validnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TrackId&#39;</span><span class="p">,</span> <span class="s1">&#39;Nbound&#39;</span><span class="p">,</span> <span class="s1">&#39;Mbound&#39;</span><span class="p">,</span> <span class="s1">&#39;HostHaloId&#39;</span><span class="p">,</span> <span class="s1">&#39;Rank&#39;</span><span class="p">,</span> <span class="s1">&#39;Depth&#39;</span><span class="p">,</span> <span class="s1">&#39;LastMaxMass&#39;</span><span class="p">,</span> <span class="s1">&#39;SnapshotIndexOfLastMaxMass&#39;</span><span class="p">,</span> <span class="s1">&#39;SnapshotIndexOfLastIsolation&#39;</span><span class="p">,</span> <span class="s1">&#39;SnapshotIndexOfBirth&#39;</span><span class="p">,</span> <span class="s1">&#39;SnapshotIndexOfDeath&#39;</span><span class="p">,</span> <span class="s1">&#39;SnapshotIndexOfSink&#39;</span><span class="p">,</span> <span class="s1">&#39;RmaxComoving&#39;</span><span class="p">,</span> <span class="s1">&#39;VmaxPhysical&#39;</span><span class="p">,</span> <span class="s1">&#39;LastMaxVmaxPhysical&#39;</span><span class="p">,</span> <span class="s1">&#39;SnapshotIndexOfLastMaxVmax&#39;</span><span class="p">,</span> <span class="s1">&#39;R2SigmaComoving&#39;</span><span class="p">,</span> <span class="s1">&#39;RHalfComoving&#39;</span><span class="p">,</span> <span class="s1">&#39;BoundR200CritComoving&#39;</span><span class="p">,</span> <span class="s1">&#39;BoundM200Crit&#39;</span><span class="p">,</span> <span class="s1">&#39;SpecificSelfPotentialEnergy&#39;</span><span class="p">,</span> <span class="s1">&#39;SpecificSelfKineticEnergy&#39;</span><span class="p">,</span> <span class="s1">&#39;SpecificAngularMomentum&#39;</span><span class="p">,</span> <span class="s1">&#39;InertialEigenVector&#39;</span><span class="p">,</span> <span class="s1">&#39;InertialEigenVectorWeighted&#39;</span><span class="p">,</span> <span class="s1">&#39;InertialTensor&#39;</span><span class="p">,</span> <span class="s1">&#39;InertialTensorWeighted&#39;</span><span class="p">,</span> <span class="s1">&#39;ComovingAveragePosition&#39;</span><span class="p">,</span> <span class="s1">&#39;PhysicalAverageVelocity&#39;</span><span class="p">,</span> <span class="s1">&#39;ComovingMostBoundPosition&#39;</span><span class="p">,</span> <span class="s1">&#39;PhysicalMostBoundVelocity&#39;</span><span class="p">,</span> <span class="s1">&#39;MostBoundParticleId&#39;</span><span class="p">,</span> <span class="s1">&#39;SinkTrackId&#39;</span><span class="p">]</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;i8&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i8&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i8&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i8&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i8&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i8&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">props</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">props</span> <span class="o">=</span> <span class="n">validnames</span>
    <span class="n">props</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
    <span class="n">indx</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="n">validnames</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">):</span> <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The following properties </span><span class="si">%s</span><span class="s1"> is not available, which has been removed from the output array.&#39;</span><span class="o">%</span><span class="n">props</span><span class="p">[</span><span class="o">~</span><span class="n">indx</span><span class="p">])</span>
    <span class="n">props</span>   <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
    <span class="n">filenum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">filenum</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenum</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The files of snapnum == </span><span class="si">%s</span><span class="s1"> are not found, return [].&#39;</span><span class="o">%</span><span class="n">snapnum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="n">branchs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="n">filenum</span><span class="p">:</span>
        <span class="n">filename</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;SubSnap_</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.hdf5&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">ifile</span> <span class="p">)</span> <span class="p">)</span> 
        <span class="n">f</span>   <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">branchs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Subhalos&#39;</span><span class="p">][:][</span><span class="n">props</span><span class="p">]</span>  <span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">arr</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">branchs</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="halo_filenum"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.halo_filenum">[docs]</a><span class="k">def</span> <span class="nf">halo_filenum</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">return_filelist</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">datadir</span> <span class="o">=</span> <span class="n">jiutian_home</span> <span class="o">+</span> <span class="s1">&#39;./M1000/groups/&#39;</span><span class="p">):</span>  
    <span class="n">filename</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;groups_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;subhalo_tab_</span><span class="si">%s</span><span class="s1">.*&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">snapnum</span><span class="p">))</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">filelist</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filenum</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)):</span> 
        <span class="n">filename</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;groups_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;subhalo_tab_</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">filenum</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span> 
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; do not exist.&quot;</span><span class="o">%</span><span class="n">filename</span><span class="p">)</span>   
        <span class="n">filelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">return_filelist</span><span class="p">:</span> 
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span> <span class="n">filelist</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> </div>

<div class="viewcode-block" id="halo"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.halo">[docs]</a><span class="k">def</span> <span class="nf">halo</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">filenum</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">datadir</span> <span class="o">=</span> <span class="n">jiutian_home</span> <span class="o">+</span> <span class="s1">&#39;./M1000/groups/&#39;</span><span class="p">):</span>

    <span class="n">have_veldisp</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">hdr_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ngroups&#39;</span><span class="p">,</span> <span class="s1">&#39;totngroups&#39;</span><span class="p">,</span> <span class="s1">&#39;nids&#39;</span><span class="p">,</span> <span class="s1">&#39;totnids&#39;</span><span class="p">,</span>  <span class="s1">&#39;ntask&#39;</span><span class="p">,</span>  <span class="s1">&#39;nsubs&#39;</span><span class="p">,</span> <span class="s1">&#39;totnsubs&#39;</span><span class="p">]</span> 
    <span class="n">hdr_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">]</span>
    <span class="n">grp_names</span> <span class="o">=</span>  <span class="p">[</span> <span class="s1">&#39;group_len&#39;</span><span class="p">,</span> <span class="s1">&#39;group_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;group_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;group_cm&#39;</span><span class="p">,</span> <span class="s1">&#39;group_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;group_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;group_m_mean200&#39;</span><span class="p">,</span> <span class="s1">&#39;group_m_crit200&#39;</span><span class="p">,</span> <span class="s1">&#39;group_m_tophat200&#39;</span><span class="p">,</span> <span class="s1">&#39;group_veldisp&#39;</span><span class="p">]</span>
    <span class="n">grp_types</span> <span class="o">=</span>  <span class="p">[</span>  <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>      <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">]</span><span class="o">+</span>     <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">))]</span><span class="o">*</span><span class="mi">3</span>    <span class="o">+</span>   <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span> 
    <span class="k">if</span> <span class="n">have_veldisp</span><span class="p">:</span>  <span class="n">grp_names</span> <span class="o">=</span> <span class="n">grp_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;group_veldisp_mean200&#39;</span><span class="p">,</span> <span class="s1">&#39;group_veldisp_crit200&#39;</span><span class="p">,</span> <span class="s1">&#39;group_veldisp_tophat200&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">have_veldisp</span><span class="p">:</span>  <span class="n">grp_types</span> <span class="o">=</span> <span class="n">grp_types</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span> 
    <span class="n">grp_names</span> <span class="o">=</span> <span class="n">grp_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;group_nsubs&#39;</span><span class="p">,</span> <span class="s1">&#39;group_firstsub&#39;</span><span class="p">]</span> 
    <span class="n">grp_types</span> <span class="o">=</span> <span class="n">grp_types</span> <span class="o">+</span> <span class="p">[</span>    <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>        <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">]</span>
    <span class="n">sub_names</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;sub_len&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_grnr&#39;</span><span class="p">,</span>  <span class="s1">&#39;sub_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_cm&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_spin&#39;</span><span class="p">]</span> 
    <span class="n">sub_types</span> <span class="o">=</span>  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>    <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">]</span><span class="o">+</span>  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">))]</span><span class="o">*</span><span class="mi">4</span>   
    <span class="n">sub_names</span> <span class="o">=</span>  <span class="n">sub_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;sub_veldisp&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_vmax&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_vmaxrad&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_halfmassrad&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_ebind&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_pot&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_parent&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_idbm&#39;</span><span class="p">]</span> 
    <span class="n">sub_types</span> <span class="o">=</span>  <span class="n">sub_types</span> <span class="o">+</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">]</span> 
   <span class="c1"># print() </span>

    <span class="k">if</span> <span class="n">props</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">props</span> <span class="o">=</span> <span class="n">hdr_names</span> <span class="o">+</span> <span class="n">grp_names</span> <span class="o">+</span> <span class="n">sub_names</span> 
    <span class="n">props</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
    <span class="n">hdr_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">hdr_names</span><span class="p">)</span>
    <span class="n">grp_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">grp_names</span><span class="p">)</span>
    <span class="n">sub_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">sub_names</span><span class="p">)</span>
    <span class="n">indx_hdr</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">hdr_names</span><span class="p">,</span> <span class="n">props</span><span class="p">);</span> 
    <span class="n">indx_grp</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">grp_names</span><span class="p">,</span> <span class="n">props</span><span class="p">);</span> 
    <span class="n">indx_sub</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sub_names</span><span class="p">,</span> <span class="n">props</span><span class="p">);</span> 

    <span class="c1">#if np.sum(indx) != len(indx): </span>
    <span class="c1">#    logging.warning(&#39;The following properties %s is not available, which has been removed from the output array.&#39;%props[~indx])</span>
    <span class="c1">#props   = props[indx]</span>
    <span class="n">filenum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">filenum</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenum</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The files of snapnum == </span><span class="si">%s</span><span class="s1"> are not found, return [].&#39;</span><span class="o">%</span><span class="n">snapnum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>


    <span class="n">branch_headers</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">branch_grps</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">branch_subs</span> <span class="o">=</span> <span class="p">[];</span> 
    <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="n">filenum</span><span class="p">:</span>
        <span class="n">filename</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;groups_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;subhalo_tab_</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">ifile</span><span class="p">))</span>
        <span class="n">f</span>        <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">header</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>   <span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">hdr_names</span><span class="p">,</span><span class="n">formats</span><span class="o">=</span><span class="n">hdr_types</span><span class="p">))</span>

        <span class="c1"># &gt;&gt;&gt; read header infomation  </span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">hdr_name</span><span class="p">,</span> <span class="n">hdr_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hdr_names</span><span class="p">,</span> <span class="n">hdr_types</span><span class="p">):</span> 
            <span class="n">header</span><span class="p">[</span><span class="n">hdr_name</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hdr_type</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">branch_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">[</span> <span class="n">hdr_names</span><span class="p">[</span><span class="n">indx_hdr</span><span class="p">]</span> <span class="p">])</span> 
        <span class="nb">print</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">hdr_names</span><span class="p">)</span> 

        <span class="c1"># &gt;&gt;&gt; read halo/subhalo infomation </span>
        <span class="c1">#</span>
        <span class="n">ngrp</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;ngroups&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nsub</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;nsubs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">arr_grp</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ngrp</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">grp_names</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="n">grp_types</span><span class="p">))</span>
        <span class="n">arr_sub</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsub</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">sub_names</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="n">sub_types</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">ngrp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>    <span class="c1">#---&gt;&gt;&gt; read halo </span>
            <span class="k">for</span> <span class="n">grp_name</span><span class="p">,</span>  <span class="n">grp_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grp_names</span><span class="p">,</span>   <span class="n">grp_types</span><span class="p">):</span>
                <span class="n">arr_grp</span><span class="p">[</span><span class="n">grp_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span> <span class="n">grp_type</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ngrp</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">nsub</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>    <span class="c1">#---&gt;&gt;&gt; read subhalo </span>
            <span class="k">for</span> <span class="n">sub_name</span><span class="p">,</span>  <span class="n">sub_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sub_names</span><span class="p">,</span>   <span class="n">sub_types</span><span class="p">):</span> 
                <span class="n">arr_sub</span><span class="p">[</span><span class="n">sub_name</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span> <span class="n">sub_type</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nsub</span><span class="p">)</span> 
        <span class="n">branch_grps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr_grp</span><span class="p">[</span> <span class="n">grp_names</span><span class="p">[</span><span class="n">indx_grp</span><span class="p">]</span> <span class="p">])</span> 
        <span class="n">branch_subs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr_sub</span><span class="p">[</span> <span class="n">sub_names</span><span class="p">[</span><span class="n">indx_sub</span><span class="p">]</span> <span class="p">])</span>
        
        <span class="n">curpos</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curpos</span> <span class="o">!=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: finished reading before EOF for file&quot;</span><span class="p">,</span><span class="n">filenum</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">branch_headers</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">branch_headers</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">branch_grps</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">branch_grps</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">branch_subs</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">branch_subs</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">branch_headers</span><span class="p">,</span> <span class="n">branch_grps</span><span class="p">,</span> <span class="n">branch_subs</span></div>

<div class="viewcode-block" id="fullsky_z2_filenum"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.fullsky_z2_filenum">[docs]</a><span class="k">def</span> <span class="nf">fullsky_z2_filenum</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">return_filelist</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">datadir</span> <span class="o">=</span> <span class="n">jiutian_home</span> <span class="o">+</span> <span class="s1">&#39;./M1000/lightcones/fullsky_z2/&#39;</span><span class="p">):</span> 
    <span class="n">filename</span>  <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s1">&#39;./with_groups/fs_z2_</span><span class="si">%i</span><span class="s1">_*.hdf5&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">filelist</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filenum</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)):</span> 
        <span class="n">filename</span>  <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s1">&#39;./with_groups/fs_z2_</span><span class="si">%i</span><span class="s1">_</span><span class="si">%i</span><span class="s1">.hdf5&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">filenum</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span> 
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; do not exist.&quot;</span><span class="o">%</span><span class="n">filename</span><span class="p">)</span> 
        <span class="n">filelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">return_filelist</span><span class="p">:</span> 
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span> <span class="n">filelist</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> </div>

<div class="viewcode-block" id="fullsky_z2"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.fullsky_z2">[docs]</a><span class="k">def</span> <span class="nf">fullsky_z2</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">filenum</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">datadir</span> <span class="o">=</span> <span class="n">jiutian_home</span> <span class="o">+</span> <span class="s1">&#39;./M1000/lightcones/fullsky_z2/&#39;</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read in the fullsky_z2 subhalo lightcone catalog (9tian lightcone of fullsky)</span>
<span class="sd">    snapnum: int </span>
<span class="sd">        valid snapshot number is 127-76, corresponding to redshift from 0 to 2. </span>
<span class="sd">    filenum: int </span>
<span class="sd">        file number of branches given the snapshot number</span>
<span class="sd">        </span>
<span class="sd">    props: list or ndarray</span>
<span class="sd">        the list of properties to return. If props == None, return all the valid properties:</span>
<span class="sd">        &#39;trackID&#39;, &#39;hosthaloID&#39;, &#39;rank&#39;, &#39;posx&#39;, &#39;posy&#39;, &#39;posz&#39;, &#39;velx&#39;, &#39;vely&#39;, &#39;velz&#39;, &#39;v_lfs&#39;, </span>
<span class="sd">        &#39;shMbound&#39;, &#39;d_comoving&#39;, &#39;ra&#39;, &#39;dec&#39;, &#39;vmax&#39;, </span>
<span class="sd">        &#39;PeakMass&#39;, &#39;PeakVmax&#39;, &#39;shBoundM200Crit&#39;, </span>
<span class="sd">        &#39;redshift_true&#39;, &#39;redshift_obs&#39;, </span>
<span class="sd">        &#39;shMbound_at_ac&#39;, &#39;snapNum&#39;, &#39;group_nr&#39;, &#39;group_mass&#39;, &#39;group_m_mean200&#39;. </span>
<span class="sd">    datadir: str</span>
<span class="sd">        the directroy of fullsky_z2 lightcone data</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    ------- </span>
<span class="sd">    arr:  numpy.ndarray </span>
<span class="sd">        numpy.ndarray corresponding to the list of properties. </span>
<span class="sd">    nextfilenum: int </span>
<span class="sd">        the next file number of branches given the snapshot number. </span>
<span class="sd">        Nextfilenum = filenum +1, when nextfilenum is available. </span>
<span class="sd">        Nextfilenum = -1, if nextfilenum is not available. </span>
<span class="sd">        </span>
<span class="sd">    example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; datadir   = &#39;/home/cossim/Jiutian/M1000/lightcones/fullsky_z2/&#39;</span>
<span class="sd">    &gt;&gt;&gt; snapnum   = 127</span>
<span class="sd">    &gt;&gt;&gt; filenum   = 0</span>
<span class="sd">    &gt;&gt;&gt; properties_used = [&#39;redshift_true&#39;, &#39;redshift_obs&#39;, &#39;aaa&#39;]</span>
<span class="sd">    &gt;&gt;&gt; arr, nextfilenum = fullsky_z2(snapnum, filenum, props = properties_used, datadir = datadir)</span>
<span class="sd">    &gt;&gt;&gt; print(&#39;The type of output array is &#39;, type(arr), &#39;with %i lines of records&#39;, np.shape(arr) )</span>
<span class="sd">    &gt;&gt;&gt; print(&#39;Names of output array&#39;, arr.dtype.names)</span>
<span class="sd">    &gt;&gt;&gt; print(&#39;Print the first row:&#39;, arr[0]) </span>
<span class="sd">    &gt;&gt;&gt; print(&quot;Print the column named &#39;redshift_true&#39;:&quot;, arr[&#39;redshift_true&#39;]) </span>
<span class="sd">    &gt;&gt;&gt; </span>
<span class="sd">    &gt;&gt;&gt; # read all </span>
<span class="sd">    &gt;&gt;&gt; filenum = 0; snapnum = 127</span>
<span class="sd">    &gt;&gt;&gt; branchs = []</span>
<span class="sd">    &gt;&gt;&gt; while filenum != -1: </span>
<span class="sd">    &gt;&gt;&gt;     branch,  nextfilenum = fullsky_z2(snapnum, filenum, props = None)</span>
<span class="sd">    &gt;&gt;&gt;     print(filenum, len(branch)) # , branch.dtype.names)</span>
<span class="sd">    &gt;&gt;&gt;     branchs.append(branch)</span>
<span class="sd">    &gt;&gt;&gt;     filenum = nextfilenum</span>
<span class="sd">    &gt;&gt;&gt; arr = np.concatenate(branchs, axis = 0) </span>
<span class="sd">    &gt;&gt;&gt; print(arr.shape, arr.dtype.names) </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">validnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;trackID&#39;</span><span class="p">,</span> <span class="s1">&#39;hosthaloID&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="s1">&#39;posx&#39;</span><span class="p">,</span> <span class="s1">&#39;posy&#39;</span><span class="p">,</span> <span class="s1">&#39;posz&#39;</span><span class="p">,</span> <span class="s1">&#39;velx&#39;</span><span class="p">,</span> <span class="s1">&#39;vely&#39;</span><span class="p">,</span> <span class="s1">&#39;velz&#39;</span><span class="p">,</span> <span class="s1">&#39;v_lfs&#39;</span><span class="p">,</span> 
                  <span class="s1">&#39;shMbound&#39;</span><span class="p">,</span> <span class="s1">&#39;d_comoving&#39;</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="s1">&#39;PeakMass&#39;</span><span class="p">,</span> <span class="s1">&#39;PeakVmax&#39;</span><span class="p">,</span> <span class="s1">&#39;shBoundM200Crit&#39;</span><span class="p">,</span> 
                  <span class="s1">&#39;redshift_true&#39;</span><span class="p">,</span> <span class="s1">&#39;redshift_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;shMbound_at_ac&#39;</span><span class="p">,</span> <span class="s1">&#39;snapNum&#39;</span><span class="p">,</span> <span class="s1">&#39;group_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;group_mass&#39;</span><span class="p">,</span> <span class="s1">&#39;group_m_mean200&#39;</span><span class="p">]</span> 
    <span class="k">if</span> <span class="n">props</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">props</span> <span class="o">=</span> <span class="n">validnames</span>
    <span class="n">props</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
    <span class="n">indx</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="n">validnames</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">):</span> <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The following properties </span><span class="si">%s</span><span class="s1"> is not available, which has been removed from the output array.&#39;</span><span class="o">%</span><span class="n">props</span><span class="p">[</span><span class="o">~</span><span class="n">indx</span><span class="p">])</span>
    <span class="n">props</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
    <span class="n">filenum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">filenum</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenum</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The files of snapnum == </span><span class="si">%s</span><span class="s1"> are not found, return [].&#39;</span><span class="o">%</span><span class="n">snapnum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    
    <span class="n">branchs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ifile</span> <span class="ow">in</span> <span class="n">filenum</span><span class="p">:</span> 
        <span class="n">filename</span>       <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s1">&#39;./with_groups/fs_z2_</span><span class="si">%i</span><span class="s1">_</span><span class="si">%i</span><span class="s1">.hdf5&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">ifile</span><span class="p">)</span> 
        <span class="n">f</span>   <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">branchs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Subhalos&#39;</span><span class="p">][:][</span><span class="n">props</span><span class="p">]</span>  <span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">arr</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">branchs</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">arr</span></div>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This &quot;io_jiutian&quot; module is writen for extracting data from Jiutian simulation. </span>

<span class="sd">collect4csstmock: perpare data for the construction of mock catalog.  </span>

<span class="sd">read_groups:  extract halo/subhalo informations of one snapshot from all subfind group files.</span>

<span class="sd">read_hbt: read subhalo information of one snapshot from all SubSnap files. </span>

<span class="sd">nexthaloid: determine the host halo id in next snapshot.</span>

<span class="sd">Wirtten by Qingyang Li, Yizhou Gu (2022/11) </span>
<span class="sd">&#39;&#39;&#39;</span> 

<div class="viewcode-block" id="read_hbt_head"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.read_hbt_head">[docs]</a><span class="k">def</span> <span class="nf">read_hbt_head</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read some headers from hbt files. </span>

<span class="sd">    Note: </span>

<span class="sd">    Cosmology in all files are same at same snapshot.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">HEAD</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;HubbleParam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Cosmology/HubbleParam&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;OmegaLambda0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Cosmology/OmegaLambda0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;OmegaM0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Cosmology/OmegaM0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;ScaleFactor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Cosmology/ScaleFactor&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;NumberOfSubhalosInAllFiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;NumberOfSubhalosInAllFiles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;NumberOfFiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;NumberOfFiles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1">#we supplyment information here</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;NumberOfSubhalosThisFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Subhalos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="s1">&#39;TrackId&#39;</span><span class="p">)[:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">HEAD</span></div>


<div class="viewcode-block" id="read_hbt_subhalos"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.read_hbt_subhalos">[docs]</a><span class="k">def</span> <span class="nf">read_hbt_subhalos</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    read subhalo information from one SubSnap file</span>

<span class="sd">    Wirtten by Qingyang Li</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename: path of file</span>
<span class="sd">    blocks: name of blocks</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Nsub: subhalo number</span>
<span class="sd">    DATA: dict, datasets of blocks</span>
<span class="sd">    DATATYPE: dict, data type of blocks </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">h5py</span>

    <span class="c1">#all names of blocks</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TrackId&#39;</span><span class="p">,</span> <span class="s1">&#39;Nbound&#39;</span><span class="p">,</span> <span class="s1">&#39;Mbound&#39;</span><span class="p">,</span> <span class="s1">&#39;HostHaloId&#39;</span><span class="p">,</span> <span class="s1">&#39;Rank&#39;</span><span class="p">,</span> <span class="s1">&#39;Depth&#39;</span><span class="p">,</span> <span class="s1">&#39;LastMaxMass&#39;</span><span class="p">,</span> <span class="s1">&#39;SnapshotIndexOfLastMaxMass&#39;</span><span class="p">,</span> <span class="s1">&#39;SnapshotIndexOfLastIsolation&#39;</span><span class="p">,</span> <span class="s1">&#39;SnapshotIndexOfBirth&#39;</span><span class="p">,</span> <span class="s1">&#39;SnapshotIndexOfDeath&#39;</span><span class="p">,</span> <span class="s1">&#39;SnapshotIndexOfSink&#39;</span><span class="p">,</span> <span class="s1">&#39;RmaxComoving&#39;</span><span class="p">,</span> <span class="s1">&#39;VmaxPhysical&#39;</span><span class="p">,</span> <span class="s1">&#39;LastMaxVmaxPhysical&#39;</span><span class="p">,</span> <span class="s1">&#39;SnapshotIndexOfLastMaxVmax&#39;</span><span class="p">,</span> <span class="s1">&#39;R2SigmaComoving&#39;</span><span class="p">,</span> <span class="s1">&#39;RHalfComoving&#39;</span><span class="p">,</span> <span class="s1">&#39;BoundR200CritComoving&#39;</span><span class="p">,</span> <span class="s1">&#39;BoundM200Crit&#39;</span><span class="p">,</span> <span class="s1">&#39;SpecificSelfPotentialEnergy&#39;</span><span class="p">,</span> <span class="s1">&#39;SpecificSelfKineticEnergy&#39;</span><span class="p">,</span> <span class="s1">&#39;SpecificAngularMomentum&#39;</span><span class="p">,</span> <span class="s1">&#39;InertialEigenVector&#39;</span><span class="p">,</span> <span class="s1">&#39;InertialEigenVectorWeighted&#39;</span><span class="p">,</span> <span class="s1">&#39;InertialTensor&#39;</span><span class="p">,</span> <span class="s1">&#39;InertialTensorWeighted&#39;</span><span class="p">,</span> <span class="s1">&#39;ComovingAveragePosition&#39;</span><span class="p">,</span> <span class="s1">&#39;PhysicalAverageVelocity&#39;</span><span class="p">,</span> <span class="s1">&#39;ComovingMostBoundPosition&#39;</span><span class="p">,</span> <span class="s1">&#39;PhysicalMostBoundVelocity&#39;</span><span class="p">,</span> <span class="s1">&#39;MostBoundParticleId&#39;</span><span class="p">,</span> <span class="s1">&#39;SinkTrackId&#39;</span><span class="p">]</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;i8&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i8&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i8&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i8&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i8&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i8&#39;</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">nbound</span><span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Subhalos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="s1">&#39;Nbound&#39;</span><span class="p">)[:]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nbound</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Nsub</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">DATA</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">DATATYPE</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
        <span class="n">readdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Subhalos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="n">block</span><span class="p">)[:]</span>
        <span class="n">readdata</span> <span class="o">=</span> <span class="n">readdata</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="c1">#select Nbound != 1</span>
        <span class="n">nblock</span>   <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="n">datatype</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="n">nblock</span><span class="p">]</span>
        <span class="c1"># datatype = data[&#39;Subhalos&#39;].dtype[nblock]</span>
        <span class="c1"># datatype = data[&#39;Subhalos&#39;].dtype.descr[nblock][1]</span>
        <span class="c1"># print(&#39;Read subhalo blocks: %s,&#39; %block + &#39; dtype:&#39;, datatype)</span>

        <span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">readdata</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">datatype</span><span class="p">)</span>
        <span class="n">DATATYPE</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">datatype</span>
    <span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Nsub</span><span class="p">,</span> <span class="n">DATA</span><span class="p">,</span> <span class="n">DATATYPE</span></div>

<div class="viewcode-block" id="read_hbt_subhalos_split"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.read_hbt_subhalos_split">[docs]</a><span class="k">def</span> <span class="nf">read_hbt_subhalos_split</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The worker of read_hbt_subhalos for parallel </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">DATA</span> <span class="o">=</span> <span class="p">{};</span> <span class="n">DATATYPE</span> <span class="o">=</span> <span class="p">{}</span> 
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>  <span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">Nsub</span> <span class="o">=</span> <span class="p">[];</span> 
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="c1">#print(filename)</span>
        <span class="n">Nsub_</span><span class="p">,</span> <span class="n">DATA_</span><span class="p">,</span> <span class="n">DATATYPE_</span> <span class="o">=</span> <span class="n">read_hbt_subhalos</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">blocks</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DATA_</span><span class="p">[</span><span class="n">block</span><span class="p">])</span>
        <span class="n">Nsub</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">Nsub_</span><span class="p">])</span>
    <span class="n">DATATYPE</span> <span class="o">=</span> <span class="n">DATATYPE_</span>
    <span class="n">Nsub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Nsub</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">blockin3D</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ComovingAveragePosition&#39;</span><span class="p">,</span> <span class="s1">&#39;PhysicalAverageVelocity&#39;</span><span class="p">,</span> <span class="s1">&#39;ComovingMostBoundPosition&#39;</span><span class="p">,</span> <span class="s1">&#39;PhysicalMostBoundVelocity&#39;</span><span class="p">]</span> 
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blockin3D</span><span class="p">:</span> 
            <span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Nsub</span><span class="p">,</span> <span class="n">DATA</span><span class="p">,</span> <span class="n">DATATYPE</span></div>

<div class="viewcode-block" id="read_hbt"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.read_hbt">[docs]</a><span class="k">def</span> <span class="nf">read_hbt</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">basedir_hbt</span> <span class="o">=</span> <span class="s1">&#39;/home/cossim/Jiutian/M1000/hbt/&#39;</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    read subhalo information from all SubSnap file with multiprocessing</span>
<span class="sd">    Wirtten by Qingyang Li</span>

<span class="sd">    Parameters: </span>
<span class="sd">    ----------</span>
<span class="sd">    snapnum: int</span>
<span class="sd">          the number of snapshot</span>
<span class="sd">    blocks:  list</span>
<span class="sd">          the name of blocks</span>
<span class="sd">    basedir_groups: str </span>
<span class="sd">          file path for subfind data (FoF)</span>

<span class="sd">    Returns:</span>
<span class="sd">    -------</span>
<span class="sd">    DATAALL: dict  </span>
<span class="sd">          datasets of blocks. for example, Nbound = DATAALL[&#39;Nbound&#39;][:]</span>
<span class="sd">    DATATYPE: dict </span>
<span class="sd">          data type of blocks</span>


<span class="sd">    Note also</span>
<span class="sd">    ---------</span>
<span class="sd">    Subhalos with Nbound&lt;=1 are not included. </span>
<span class="sd">    &#39;&#39;&#39;</span> 
    
    <span class="c1">#initialize data</span>
    <span class="n">DATAALL</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filedir</span>   <span class="o">=</span> <span class="n">basedir_hbt</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> \
                <span class="s1">&#39;/SubSnap_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">filedir</span> <span class="o">+</span> <span class="s1">&#39;*.hdf5&#39;</span><span class="p">)</span> 
    <span class="n">division</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="c1"># the divided  number</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">filedir</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.hdf5&#39;</span><span class="o">%</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">division</span><span class="p">)</span> <span class="p">]</span> 
    
    <span class="n">size</span>        <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> 
    <span class="k">if</span> <span class="n">division</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No found in &#39;</span> <span class="o">+</span> <span class="n">filedir</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading </span><span class="si">%s</span><span class="s1"> hbt divisions of </span><span class="si">%s</span><span class="s1">th snapshot with </span><span class="si">%s</span><span class="s1"> threads&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">division</span><span class="p">,</span> <span class="n">snapnum</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="p">)</span> 

    <span class="c1">#split task &amp; start parallel</span>
    <span class="n">task_splits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> 
    <span class="n">res</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">read_hbt_subhalos_split</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">task_splits</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">blocks</span><span class="p">)</span> <span class="p">)</span> 
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">NSUB</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
        <span class="n">Nsub_</span><span class="p">,</span> <span class="n">DATA</span><span class="p">,</span> <span class="n">DATATYPE</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> 
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">])</span>
        <span class="n">NSUB</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Nsub_</span><span class="p">)</span> 
    <span class="n">NSUB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">NSUB</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">blockin3D</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ComovingAveragePosition&#39;</span><span class="p">,</span> <span class="s1">&#39;PhysicalAverageVelocity&#39;</span><span class="p">,</span> <span class="s1">&#39;ComovingMostBoundPosition&#39;</span><span class="p">,</span> <span class="s1">&#39;PhysicalMostBoundVelocity&#39;</span><span class="p">]</span> 
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>  
        <span class="k">if</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blockin3D</span><span class="p">:</span> 
            <span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">])</span> 
    <span class="k">return</span> <span class="n">DATAALL</span><span class="p">,</span> <span class="n">DATATYPE</span></div>

<div class="viewcode-block" id="subfind_catalog"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.subfind_catalog">[docs]</a><span class="k">class</span> <span class="nc">subfind_catalog</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  code for reading Subfind&#39;s subhalo_tab files</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curfile</span><span class="p">):</span> 
 
    <span class="c1">#self.filebase = basedir + &quot;/groups_&quot; + str(snapnum).zfill(3) + &quot;/subhalo_tab_&quot; + str(snapnum).zfill(3) + &quot;.&quot;</span>
 
    <span class="c1">#print()</span>
    <span class="c1">#print(&quot;reading subfind catalog for snapshot&quot;,snapnum,&quot;of&quot;,basedir)</span>
 
    <span class="n">have_veldisp</span> <span class="o">=</span> <span class="kc">True</span>
 
    <span class="c1">#curfile = self.filebase + str(filenum)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">curfile</span><span class="p">)):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;file not found:&quot;</span><span class="p">,</span> <span class="n">curfile</span><span class="p">)</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curfile</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    
    <span class="n">ngroups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>    <span class="c1"># Number of groups within this file</span>
    <span class="n">totngroups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Total number of groups for this snapshot.</span>
    <span class="n">nids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>       
    <span class="n">totnids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ntask</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nsubs</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">totnsubs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">ngroups</span><span class="o">=</span> <span class="n">ngroups</span> <span class="c1"># Number of    groups within this file chunk.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nids</span>   <span class="o">=</span> <span class="n">nids</span>  <span class="c1"># ???? print(self.nids)  </span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nfiles</span> <span class="o">=</span> <span class="n">ntask</span> <span class="c1"># Total number of file chunks the group catalog is split between.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nsubs</span>  <span class="o">=</span> <span class="n">nsubs</span> <span class="c1"># Number of subgroups within this file chunk.</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">totngrp</span> <span class="o">=</span> <span class="n">totngroups</span> <span class="c1"># Total number of    groups for this snapshot.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">totnsub</span> <span class="o">=</span> <span class="n">totnsubs</span>   <span class="c1"># Total number of subgroups for this snapshot.</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">group_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_m_mean200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_m_crit200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_m_tophat200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_veldisp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">have_veldisp</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">group_veldisp_mean200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">group_veldisp_crit200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">group_veldisp_tophat200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_nsubs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_firstsub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ngroups</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">nsubs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_grnr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_spin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_veldisp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_vmaxrad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_halfmassrad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="c1">#self.sub_shape = np.empty(nsubs, dtype=np.dtype((np.float32,6)))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_ebind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_pot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="c1">#self.sub_profile = np.empty(nsubs, dtype=np.dtype((np.float32,9)))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_idbm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nsubs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
    <span class="c1">#--------------------------------------------------------------------</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>
    <span class="c1"># group_len - Integer counter of the total number of particles/cells of all types in this group.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">group_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>
    <span class="c1"># group_cm  (N,3) - Center of mass of the group (mass weighted relative coordinates of all particles/cells in the group)</span>
    <span class="c1"># group_vel (N,3) - Velocity of the group, The peculiar velocity is obtained by multiplying this value by 1/a. </span>
    <span class="c1"># group_pos (N,3) - Spatial position within the periodic box (of the particle with the minimum gravitational potential energy)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_m_mean200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_m_crit200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_m_tophat200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_veldisp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">have_veldisp</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">group_veldisp_mean200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">group_veldisp_crit200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">group_veldisp_tophat200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">group_nsubs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">group_firstsub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ngroups</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nsubs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_grnr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="c1"># group_cm  (N,3) - Center of mass of the subgroup</span>
      <span class="c1"># group_vel (N,3) - Velocity of the subgroup </span>
      <span class="c1"># group_pos (N,3) - Spatial position within the periodic box </span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_spin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_veldisp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="c1"># sub_veldisp N   - One-dimensional velocity dispersion of all the member particles/cells (the 3D dispersion divided by sqrt(3) ).</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_vmaxrad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_halfmassrad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="c1">#self.sub_shape = np.fromfile(f, dtype=np.dtype((np.float32,6)), count=nsubs)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_ebind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_pot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="c1">#self.sub_profile = np.fromfile(f, dtype=np.dtype((np.float32,9)), count=nsubs)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sub_idbm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nsubs</span><span class="p">)</span>

      <span class="n">curpos</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
      <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">curpos</span> <span class="o">!=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: finished reading before EOF for file&quot;</span><span class="p">,</span><span class="n">filenum</span><span class="p">)</span>
      <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  </div>

    
<div class="viewcode-block" id="read_groups_subhalos"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.read_groups_subhalos">[docs]</a><span class="k">def</span> <span class="nf">read_groups_subhalos</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
    <span class="n">dmpm</span> <span class="o">=</span> <span class="mf">0.03722953</span> <span class="c1">#dark matter particle mass</span>
    <span class="n">DATAALL</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">DATATYPE</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span> 
        <span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">DATATYPE</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">grp_</span><span class="o">=</span> <span class="n">subfind_catalog</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> 
    <span class="n">nh_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">grp_</span><span class="o">.</span><span class="n">group_nr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#number of groups</span>
    <span class="n">ns_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">grp_</span><span class="o">.</span><span class="n">sub_nr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#number of subhalos </span>
    <span class="c1">#group information</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">block</span> <span class="o">==</span> <span class="s1">&#39;group_mass&#39;</span><span class="p">:</span>
                <span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">grp_</span><span class="o">.</span><span class="n">group_len</span><span class="o">*</span><span class="n">dmpm</span><span class="p">)</span><span class="o">+</span><span class="mi">10</span>
                <span class="n">DATATYPE</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;float32&#39;</span>
        <span class="k">elif</span> <span class="n">block</span> <span class="o">==</span> <span class="s1">&#39;sub_mass&#39;</span><span class="p">:</span>
                <span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">grp_</span><span class="o">.</span><span class="n">sub_len</span><span class="o">*</span><span class="n">dmpm</span><span class="p">)</span><span class="o">+</span><span class="mi">10</span> 
                <span class="n">DATATYPE</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;float32&#39;</span>
        <span class="k">else</span><span class="p">:</span>
                <span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">grp_</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span> 
                <span class="n">DATATYPE</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">grp_</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>
    <span class="k">return</span> <span class="n">nh_</span><span class="p">,</span> <span class="n">ns_</span><span class="p">,</span> <span class="n">DATAALL</span><span class="p">,</span> <span class="n">DATATYPE</span></div>

<div class="viewcode-block" id="read_groups_subhalos_split"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.read_groups_subhalos_split">[docs]</a><span class="k">def</span> <span class="nf">read_groups_subhalos_split</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The worker of read_groups_subhalos for parallel </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">DATA</span> <span class="o">=</span> <span class="p">{};</span> <span class="n">DATATYPE</span> <span class="o">=</span> <span class="p">{}</span> 
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>  <span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">Ns</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">Nh</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="n">Nh_</span><span class="p">,</span> <span class="n">Ns_</span><span class="p">,</span> <span class="n">DATA_</span><span class="p">,</span> <span class="n">DATATYPE_</span> <span class="o">=</span> <span class="n">read_groups_subhalos</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">blocks</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DATA_</span><span class="p">[</span><span class="n">block</span><span class="p">])</span>
        <span class="n">Nh</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">Nh_</span><span class="p">])</span>
        <span class="n">Ns</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">Ns_</span><span class="p">])</span>
    <span class="n">Nh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Nh</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">Ns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ns</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">DATATYPE</span> <span class="o">=</span> <span class="n">DATATYPE_</span>
    <span class="n">blockin3D</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;group_cm&#39;</span><span class="p">,</span> <span class="s1">&#39;group_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;group_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_cm&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_spin&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blockin3D</span><span class="p">:</span> 
            <span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Nh</span><span class="p">,</span> <span class="n">Ns</span><span class="p">,</span> <span class="n">DATA</span><span class="p">,</span> <span class="n">DATATYPE</span></div>

<div class="viewcode-block" id="read_groups"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.read_groups">[docs]</a><span class="k">def</span> <span class="nf">read_groups</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">basedir_groups</span> <span class="o">=</span> <span class="s1">&#39;/home/cossim/Jiutian/M1000/groups/&#39;</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    extract halo/subhalo informations from all subfind group files with multiprocessing </span>

<span class="sd">    Wirtten by Qingyang Li, Yizhou Gu</span>

<span class="sd">    Parameters: </span>
<span class="sd">    ----------</span>
<span class="sd">    snapnum: int</span>
<span class="sd">          the number of snapshot</span>
<span class="sd">    blocks:  list</span>
<span class="sd">          the name of blocks</span>
<span class="sd">    basedir_groups: str </span>
<span class="sd">          file path for subfind data (FoF)</span>

<span class="sd">    Returns:</span>
<span class="sd">    -------</span>
<span class="sd">    DATAALL: dict  </span>
<span class="sd">          datasets of blocks. For example, group_pos = DATAALL[&#39;group_pos&#39;][:]</span>
<span class="sd">    DATATYPE: dict </span>
<span class="sd">          data type of blocks</span>
<span class="sd">    </span>
<span class="sd">    Note also: </span>
<span class="sd">    ---------</span>
<span class="sd">    Host halo and subhalo information can be obtained together.</span>
<span class="sd">    &#39;&#39;&#39;</span>
        
    <span class="c1">#initialize data</span>
    <span class="n">DATAALL</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filedir</span>   <span class="o">=</span> <span class="n">basedir_groups</span> <span class="o">+</span> <span class="s1">&#39;/groups_&#39;</span><span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> \
                <span class="s1">&#39;/subhalo_tab_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">snapnum</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">filedir</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span> 
    <span class="n">division</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="c1"># the divided  number</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">filedir</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">division</span><span class="p">)</span> <span class="p">]</span> 

    <span class="n">size</span>        <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> 
    
    <span class="k">if</span> <span class="n">division</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No found in &#39;</span> <span class="o">+</span> <span class="n">filedir</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading </span><span class="si">%s</span><span class="s1"> groups divisions of </span><span class="si">%s</span><span class="s1">th snapshot with </span><span class="si">%s</span><span class="s1"> threads&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">division</span><span class="p">,</span> <span class="n">snapnum</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> 

    <span class="c1">#split task &amp; start parallel</span>
    <span class="n">task_splits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> 
    <span class="n">res</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">read_groups_subhalos_split</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">task_splits</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">blocks</span><span class="p">)</span> <span class="p">)</span> 
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="n">NSUB</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
        <span class="n">Nh_</span><span class="p">,</span> <span class="n">Ns_</span><span class="p">,</span> <span class="n">DATA</span><span class="p">,</span> <span class="n">DATATYPE</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> 
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DATA</span><span class="p">[</span><span class="n">block</span><span class="p">])</span>
        
    <span class="n">blockin3D</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;group_cm&#39;</span><span class="p">,</span> <span class="s1">&#39;group_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;group_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_cm&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_spin&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blockin3D</span><span class="p">:</span> 
            <span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">DATAALL</span><span class="p">[</span><span class="n">block</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">DATAALL</span><span class="p">,</span> <span class="n">DATATYPE</span></div>
    
<div class="viewcode-block" id="collect4csstmock"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.collect4csstmock">[docs]</a><span class="k">def</span> <span class="nf">collect4csstmock</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">basedir_hbt</span><span class="p">,</span> <span class="n">basedir_groups</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Collect input data for construction of csstmock from Jiutian using multiprocessing. </span>
<span class="sd">    Using 72 threads, it takes ~ 20 min (10 min for readin and 10 min for finding next halo id).</span>

<span class="sd">    Wirtten by Qingyang Li, Yizhou Gu</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    snapnum: int </span>
<span class="sd">          the number of snapshot</span>
<span class="sd">    basedir_hbt: str</span>
<span class="sd">          file path for hbt data</span>
<span class="sd">    basedir_groups: str</span>
<span class="sd">          file path for subfind data (FoF)</span>

<span class="sd">    Return:</span>
<span class="sd">    -------</span>
<span class="sd">    Nsubs: int </span>
<span class="sd">           number of subhalos</span>
<span class="sd">    INPUT_FORT_LONG: ndarray </span>
<span class="sd">           include all int64  type data information</span>
<span class="sd">    INPUT_FORT_DOUBLE: ndarray </span>
<span class="sd">           include all float64 type data information</span>

<span class="sd">    Details of subhalo information:</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; INPUT_FORT_LONG (np.int64):</span>
<span class="sd">    &gt;&gt;&gt; 1. &#39;host_id&#39;:   host halo ID in present snapshot</span>
<span class="sd">    &gt;&gt;&gt; 2. &#39;rank&#39;:      subhalo order (rank==1: central halo (most massive); rank ==0: subhalos) </span>
<span class="sd">    &gt;&gt;&gt; 3. &#39;sub_id&#39;:    trackID </span>
<span class="sd">    &gt;&gt;&gt; 4. &#39;host_nextid&#39;: host halo ID in next snapshot (-99 means not found)</span>

<span class="sd">    &gt;&gt;&gt; INPUT_FORT_DOUBLE (np.float64): </span>
<span class="sd">    &gt;&gt;&gt; 1-3. &#39;sub_pos&#39;: position (x, y, z) </span>
<span class="sd">    &gt;&gt;&gt; 4-6. &#39;sub_velocity&#39;: velocity (vx, vy, vz): </span>
<span class="sd">    &gt;&gt;&gt; 7.   &#39;host_mass&#39;: host halo mass</span>
<span class="sd">    &gt;&gt;&gt; 8.   &#39;sub_mass&#39;:  subhalo mass:  </span>
<span class="sd">    &gt;&gt;&gt; 9.   &#39;Peakmass&#39;: Peakmass</span>
<span class="sd">    &gt;&gt;&gt; 10.  &#39;sub_velmax&#39;: maximum circular velocity of subhalo</span>
<span class="sd">    &gt;&gt;&gt; </span>
<span class="sd">    &gt;&gt;&gt; Note: </span>
<span class="sd">    &gt;&gt;&gt; mass in unit of Msun/h using log values </span>
<span class="sd">    &gt;&gt;&gt; cordinates in unit of Mpc/h </span>
<span class="sd">    &gt;&gt;&gt; velocity in unit of km/s</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
<span class="c1">#</span>
<span class="c1">#--- reading the present snapshot ---</span>
<span class="c1">#</span>
    <span class="c1"># subhalo information from HBT </span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ComovingAveragePosition&#39;</span><span class="p">,</span> <span class="s1">&#39;PhysicalAverageVelocity&#39;</span><span class="p">,</span> <span class="s1">&#39;LastMaxMass&#39;</span><span class="p">,</span><span class="s1">&#39;VmaxPhysical&#39;</span><span class="p">,</span><span class="s1">&#39;Mbound&#39;</span><span class="p">,</span> <span class="s1">&#39;Nbound&#39;</span><span class="p">,</span> <span class="s1">&#39;Rank&#39;</span><span class="p">,</span> <span class="s1">&#39;TrackId&#39;</span><span class="p">,</span> <span class="s1">&#39;HostHaloId&#39;</span><span class="p">]</span>
    <span class="n">DATACOLLECT_hbt</span><span class="p">,</span> <span class="n">DATATYPE_hbt</span> <span class="o">=</span> <span class="n">read_hbt</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">basedir_hbt</span><span class="p">)</span>
    <span class="c1"># host halo information from subfind</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;group_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;group_mass&#39;</span><span class="p">]</span>
    <span class="n">DATACOLLECT_groups</span><span class="p">,</span> <span class="n">DATATYPE_groups</span>   <span class="o">=</span> <span class="n">read_groups</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">basedir_groups</span><span class="p">)</span> 

<span class="c1">#</span>
<span class="c1">#--- reading next snapshot ---</span>
<span class="c1">#</span>
    <span class="k">if</span> <span class="n">snapnum</span> <span class="o">!=</span> <span class="mi">127</span><span class="p">:</span> 
        <span class="c1">#subhalo information from HBT</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TrackId&#39;</span><span class="p">,</span> <span class="s1">&#39;HostHaloId&#39;</span><span class="p">]</span>
        <span class="n">DATACOLLECT_hbt_next</span><span class="p">,</span> <span class="n">DATATYPE_hbt_next</span> <span class="o">=</span> <span class="n">read_hbt</span><span class="p">(</span><span class="n">snapnum</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">basedir_hbt</span><span class="p">)</span>
       
        <span class="c1">#host halo information from subfind</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;group_nr&#39;</span><span class="p">]</span> 
        <span class="n">DATACOLLECT_groups_next</span><span class="p">,</span> <span class="n">DATATYPE_groups_next</span> <span class="o">=</span> <span class="n">read_groups</span><span class="p">(</span><span class="n">snapnum</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">basedir_groups</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">snapnum</span> <span class="o">!=</span> <span class="mi">127</span><span class="p">:</span> 
       <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reading </span><span class="si">%s</span><span class="s1">th and </span><span class="si">%s</span><span class="s1">th snapshots time is </span><span class="si">%.3f</span><span class="s1"> s&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">snapnum</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">snapnum</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span> 
       <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reading </span><span class="si">%s</span><span class="s1">th snapshots time is </span><span class="si">%.3f</span><span class="s1"> s&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
<span class="c1">#---- finish reading, ~ 10 min.  </span>

<span class="c1">#==============================================================================</span>
<span class="c1">#</span>
<span class="c1">#--- prepare the data array for the construction of CSST mock </span>
<span class="c1">#</span>
    <span class="c1"># the number of subhalo from HBT </span>
    <span class="n">Nsubs</span>    <span class="o">=</span> <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;TrackId&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
    <span class="n">arg_hbt</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;TrackId&#39;</span><span class="p">][:])</span>
    <span class="k">if</span> <span class="n">snapnum</span> <span class="o">!=</span> <span class="mi">127</span><span class="p">:</span>
        <span class="n">arg_hbt_next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">DATACOLLECT_hbt_next</span><span class="p">[</span><span class="s1">&#39;TrackId&#39;</span><span class="p">][:])</span>
    
    
    <span class="c1"># Data array which is Long type</span>

    <span class="n">INPUT_FORT_LONG</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Nsubs</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>  <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">INPUT_FORT_LONG</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;TrackId&#39;</span><span class="p">][</span><span class="n">arg_hbt</span><span class="p">]</span>
    <span class="n">INPUT_FORT_LONG</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;Rank&#39;</span><span class="p">][</span><span class="n">arg_hbt</span><span class="p">]</span>
    <span class="n">idx_host</span>   <span class="o">=</span> <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;HostHaloId&#39;</span><span class="p">][:]</span> <span class="c1"># hbt gives the index of host halos log Mh [Msub/h]</span>
    <span class="n">hosthaloid</span> <span class="o">=</span> <span class="n">DATACOLLECT_groups</span><span class="p">[</span><span class="s1">&#39;group_nr&#39;</span><span class="p">][</span><span class="n">idx_host</span><span class="p">]</span>
    <span class="n">idx_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idx_host</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hosthaloid</span><span class="p">[</span><span class="n">idx_field</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># for field subhalos</span>
    <span class="n">INPUT_FORT_LONG</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">hosthaloid</span><span class="p">[</span><span class="n">arg_hbt</span><span class="p">]</span>
    
    <span class="c1"># determine the host halo id in next snapshot</span>
    <span class="k">if</span> <span class="n">snapnum</span> <span class="o">!=</span> <span class="mi">127</span><span class="p">:</span> 
        <span class="n">idx_host_next</span>  <span class="o">=</span> <span class="n">DATACOLLECT_hbt_next</span><span class="p">[</span><span class="s1">&#39;HostHaloId&#39;</span><span class="p">][:]</span>
        <span class="n">next_groups_id</span> <span class="o">=</span> <span class="n">DATACOLLECT_groups_next</span><span class="p">[</span><span class="s1">&#39;group_nr&#39;</span><span class="p">][</span><span class="n">idx_host_next</span><span class="p">]</span>
        <span class="n">idx_field_next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idx_host_next</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">next_groups_id</span><span class="p">[</span><span class="n">idx_field_next</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># for field subhalos</span>
        
        <span class="n">nexthaloid_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">INPUT_FORT_LONG</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">nexthaloid</span><span class="p">(</span>  <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;TrackId&#39;</span><span class="p">][</span><span class="n">arg_hbt</span><span class="p">],</span> \
                                            <span class="n">DATACOLLECT_hbt_next</span><span class="p">[</span><span class="s1">&#39;TrackId&#39;</span><span class="p">][</span><span class="n">arg_hbt_next</span><span class="p">],</span> \
                                            <span class="n">next_groups_id</span><span class="p">[</span><span class="n">arg_hbt_next</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">snapnum</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span> <span class="n">INPUT_FORT_LONG</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    
    <span class="c1"># print(&#39;time for finding next host halo id is %.3f s&#39; %(time.time() - nexthaloid_time) )</span>

    <span class="c1"># Data array which is Double type</span>

    <span class="n">INPUT_FORT_DOUBLE</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Nsubs</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;ComovingAveragePosition&#39;</span><span class="p">][</span><span class="n">arg_hbt</span><span class="p">]</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;PhysicalAverageVelocity&#39;</span><span class="p">][</span><span class="n">arg_hbt</span><span class="p">]</span>
    <span class="n">hosthalomass</span>   <span class="o">=</span> <span class="n">DATACOLLECT_groups</span><span class="p">[</span><span class="s1">&#39;group_mass&#39;</span><span class="p">][</span><span class="n">idx_host</span><span class="p">]</span>
    <span class="n">hosthalomass</span><span class="p">[</span><span class="n">idx_field</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span>   <span class="o">=</span> <span class="n">hosthalomass</span><span class="p">[</span><span class="n">arg_hbt</span><span class="p">]</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;Mbound&#39;</span><span class="p">][</span><span class="n">arg_hbt</span><span class="p">])</span> <span class="o">+</span> <span class="mi">10</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">8</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;LastMaxMass&#39;</span><span class="p">][</span><span class="n">arg_hbt</span><span class="p">])</span> <span class="o">+</span> <span class="mi">10</span> 
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">9</span><span class="p">]</span>   <span class="o">=</span> <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;VmaxPhysical&#39;</span><span class="p">][</span><span class="n">arg_hbt</span><span class="p">]</span> 
    
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reading the snapshot takes </span><span class="si">%.3f</span><span class="s1"> s in total&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">Nsubs</span><span class="p">,</span> <span class="n">INPUT_FORT_LONG</span><span class="p">,</span> <span class="n">INPUT_FORT_DOUBLE</span></div>


<div class="viewcode-block" id="readsnapshot"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.readsnapshot">[docs]</a><span class="k">def</span> <span class="nf">readsnapshot</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">basedir_hbt</span><span class="p">,</span> <span class="n">basedir_groups</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Collect input data for construction of csstmock from Jiutian using multiprocessing. </span>
<span class="sd">    Using 72 threads, it takes ~ 20 min (10 min for readin and 10 min for finding next halo id).</span>

<span class="sd">    Wirtten by Qingyang Li, Yizhou Gu</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    snapnum: int </span>
<span class="sd">          the number of snapshot</span>
<span class="sd">    basedir_hbt: str</span>
<span class="sd">          file path for hbt data</span>
<span class="sd">    basedir_groups: str</span>
<span class="sd">          file path for subfind data (FoF)</span>

<span class="sd">    Return:</span>
<span class="sd">    -------</span>
<span class="sd">    Nsubs: int </span>
<span class="sd">           number of subhalos</span>
<span class="sd">    INPUT_FORT_LONG: ndarray </span>
<span class="sd">           include all int64  type data information</span>
<span class="sd">    INPUT_FORT_DOUBLE: ndarray </span>
<span class="sd">           include all float64 type data information</span>

<span class="sd">    Details of subhalo information:</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; INPUT_FORT_LONG (np.int64):</span>
<span class="sd">    &gt;&gt;&gt; 1. &#39;host_id&#39;:   host halo ID in present snapshot</span>
<span class="sd">    &gt;&gt;&gt; 2. &#39;rank&#39;:      subhalo order (rank==1: central halo (most massive); rank ==0: subhalos) </span>
<span class="sd">    &gt;&gt;&gt; 3. &#39;sub_id&#39;:    trackID </span>
<span class="sd">    &gt;&gt;&gt; 4. &#39;host_nextid&#39;: host halo ID in next snapshot (-99 means not found)</span>

<span class="sd">    &gt;&gt;&gt; INPUT_FORT_DOUBLE (np.float64): </span>
<span class="sd">    &gt;&gt;&gt; 1-3. &#39;sub_pos&#39;: position (x, y, z) </span>
<span class="sd">    &gt;&gt;&gt; 4-6. &#39;sub_velocity&#39;: velocity (vx, vy, vz): </span>
<span class="sd">    &gt;&gt;&gt; 7.   &#39;host_mass&#39;: host halo mass</span>
<span class="sd">    &gt;&gt;&gt; 8.   &#39;sub_mass&#39;:  subhalo mass:  </span>
<span class="sd">    &gt;&gt;&gt; 9.   &#39;Peakmass&#39;: Peakmass</span>
<span class="sd">    &gt;&gt;&gt; 10.  &#39;sub_velmax&#39;: maximum circular velocity of subhalo</span>
<span class="sd">    &gt;&gt;&gt; </span>
<span class="sd">    &gt;&gt;&gt; Note: </span>
<span class="sd">    &gt;&gt;&gt; mass in unit of Msun/h using log values </span>
<span class="sd">    &gt;&gt;&gt; cordinates in unit of Mpc/h </span>
<span class="sd">    &gt;&gt;&gt; velocity in unit of km/s</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
<span class="c1">#</span>
<span class="c1">#--- reading the present snapshot ---</span>
<span class="c1">#</span>
    <span class="c1"># subhalo information from HBT </span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ComovingAveragePosition&#39;</span><span class="p">,</span> <span class="s1">&#39;PhysicalAverageVelocity&#39;</span><span class="p">,</span> <span class="s1">&#39;LastMaxMass&#39;</span><span class="p">,</span><span class="s1">&#39;VmaxPhysical&#39;</span><span class="p">,</span><span class="s1">&#39;Mbound&#39;</span><span class="p">,</span> <span class="s1">&#39;Nbound&#39;</span><span class="p">,</span> <span class="s1">&#39;Rank&#39;</span><span class="p">,</span> <span class="s1">&#39;TrackId&#39;</span><span class="p">,</span> <span class="s1">&#39;HostHaloId&#39;</span><span class="p">]</span>
    <span class="n">DATACOLLECT_hbt</span><span class="p">,</span> <span class="n">DATATYPE_hbt</span> <span class="o">=</span> <span class="n">read_hbt</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">basedir_hbt</span><span class="p">)</span>
    <span class="c1"># host halo information from subfind</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;group_nr&#39;</span><span class="p">,</span> <span class="s1">&#39;group_mass&#39;</span><span class="p">]</span>
    <span class="n">DATACOLLECT_groups</span><span class="p">,</span> <span class="n">DATATYPE_groups</span>   <span class="o">=</span> <span class="n">read_groups</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">basedir_groups</span><span class="p">)</span> 
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reading </span><span class="si">%s</span><span class="s1">th snapshots time is </span><span class="si">%.3f</span><span class="s1"> s&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
<span class="c1">#---- finish reading, ~ 10 min.  </span>

<span class="c1">#==============================================================================</span>
<span class="c1">#</span>
<span class="c1">#--- prepare the data array for the construction of CSST mock </span>
<span class="c1">#</span>
    <span class="c1"># the number of subhalo from HBT </span>
    <span class="n">Nsubs</span>    <span class="o">=</span> <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;TrackId&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
    <span class="c1">#arg_hbt  = np.argsort(DATACOLLECT_hbt[&#39;TrackId&#39;][:])</span>

    <span class="c1"># Data array which is Long type</span>

    <span class="n">INPUT_FORT_LONG</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Nsubs</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>  <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">idx_host</span>   <span class="o">=</span> <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;HostHaloId&#39;</span><span class="p">][:]</span> <span class="c1"># hbt gives the index of host halos log Mh [Msub/h]</span>
    <span class="n">hosthaloid</span> <span class="o">=</span> <span class="n">DATACOLLECT_groups</span><span class="p">[</span><span class="s1">&#39;group_nr&#39;</span><span class="p">][</span><span class="n">idx_host</span><span class="p">]</span>
    <span class="n">idx_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idx_host</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hosthaloid</span><span class="p">[</span><span class="n">idx_field</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>                    <span class="c1"># for field subhalos  </span>
    <span class="n">INPUT_FORT_LONG</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hosthaloid</span><span class="p">[:]</span>
    <span class="n">INPUT_FORT_LONG</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;Rank&#39;</span><span class="p">][:]</span>
    <span class="n">INPUT_FORT_LONG</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;TrackId&#39;</span><span class="p">][:]</span>

    <span class="c1"># Data array which is Double type</span>

    <span class="n">INPUT_FORT_DOUBLE</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Nsubs</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;ComovingAveragePosition&#39;</span><span class="p">][:]</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;PhysicalAverageVelocity&#39;</span><span class="p">][:]</span>
    <span class="n">hosthalomass</span>   <span class="o">=</span> <span class="n">DATACOLLECT_groups</span><span class="p">[</span><span class="s1">&#39;group_mass&#39;</span><span class="p">][</span><span class="n">idx_host</span><span class="p">]</span>
    <span class="n">hosthalomass</span><span class="p">[</span><span class="n">idx_field</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span>   <span class="o">=</span> <span class="n">hosthalomass</span><span class="p">[:]</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;Mbound&#39;</span><span class="p">][:])</span> <span class="o">+</span> <span class="mi">10</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">8</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;LastMaxMass&#39;</span><span class="p">][:])</span> <span class="o">+</span> <span class="mi">10</span> 
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">9</span><span class="p">]</span>   <span class="o">=</span> <span class="n">DATACOLLECT_hbt</span><span class="p">[</span><span class="s1">&#39;VmaxPhysical&#39;</span><span class="p">][:]</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reading the snapshot takes </span><span class="si">%.3f</span><span class="s1"> s in total&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">Nsubs</span><span class="p">,</span> <span class="n">INPUT_FORT_LONG</span><span class="p">,</span> <span class="n">INPUT_FORT_DOUBLE</span></div>



<div class="viewcode-block" id="nexthaloid"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.nexthaloid">[docs]</a><span class="k">def</span> <span class="nf">nexthaloid</span><span class="p">(</span><span class="n">TrackId</span><span class="p">,</span> <span class="n">TrackIdnext</span><span class="p">,</span> <span class="n">GroupsIdnext</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    determine the host halo id in next snapshot. </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    TrackId: ndarray, int64 </span>
<span class="sd">            TrackId in present snapshot</span>
<span class="sd">    TrackIdnext: ndarray, int64</span>
<span class="sd">            TrackId in next snapshot</span>
<span class="sd">    GroupsIdnext: ndarray, int64</span>
<span class="sd">            GroupsId (host halo id) in next snapshot from subfind data (FoF)</span>
<span class="sd">    </span>
<span class="sd">    Return:</span>
<span class="sd">    -------</span>
<span class="sd">    GroupsId: ndarray, int64</span>
<span class="sd">            the corresponding GroupsId (host halo id) in next snapshot or -99 (no match) </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># finding subhalo id in next snapshot</span>
    <span class="n">idx_in_next</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span> <span class="n">TrackIdnext</span><span class="p">,</span> <span class="n">TrackId</span><span class="p">,</span> <span class="n">assume_unique</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">TrackId_match</span>  <span class="o">=</span> <span class="n">TrackIdnext</span><span class="p">[</span><span class="n">idx_in_next</span><span class="p">]</span>  <span class="c1"># Using TrackId to match</span>
    <span class="n">GroupsID_match</span> <span class="o">=</span> <span class="n">GroupsIdnext</span><span class="p">[</span><span class="n">idx_in_next</span><span class="p">]</span>
    
    <span class="c1"># finding host halo id in next snapshot correspond to the present subhalos</span>
    <span class="n">ind_in_prev</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span>  <span class="n">TrackId</span><span class="p">,</span> <span class="n">TrackId_match</span><span class="p">,</span> <span class="n">assume_unique</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
    <span class="n">GroupsId</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">TrackId</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">99</span> 
    <span class="n">GroupsId</span><span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ind_in_prev</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="n">GroupsID_match</span>
    <span class="k">return</span> <span class="n">GroupsId</span></div>



<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<div class="viewcode-block" id="read_edition0"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.read_edition0">[docs]</a><span class="k">def</span> <span class="nf">read_edition0</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read the light-cone of Jiu-tian generated by Zhenlin Tan. </span>
<span class="sd">    --&gt;  a small, test edition of Jiutian lightcone.</span>
<span class="sd">    parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    return: </span>
<span class="sd">    -------</span>
<span class="sd">    </span>
<span class="sd">    This script is written by Zhenlin Tan</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 

    <span class="n">output_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;trackID&#39;</span><span class="p">,</span> <span class="s1">&#39;hosthaloID&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="s1">&#39;posx&#39;</span><span class="p">,</span> <span class="s1">&#39;posy&#39;</span><span class="p">,</span> <span class="s1">&#39;posz&#39;</span><span class="p">,</span> <span class="s1">&#39;velx&#39;</span><span class="p">,</span> <span class="s1">&#39;vely&#39;</span><span class="p">,</span> <span class="s1">&#39;velz&#39;</span><span class="p">,</span> <span class="s1">&#39;v_lfs&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;shMbound&#39;</span><span class="p">,</span> <span class="s1">&#39;d_comoving&#39;</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="s1">&#39;PeakMass&#39;</span><span class="p">,</span> <span class="s1">&#39;PeakVmax&#39;</span><span class="p">,</span> <span class="s1">&#39;Mvir&#39;</span><span class="p">,</span><span class="s1">&#39;Rvir&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;shBoundM200Crit&#39;</span><span class="p">,</span><span class="s1">&#39;M200mean&#39;</span><span class="p">,</span> <span class="s1">&#39;redshift_true&#39;</span><span class="p">,</span> <span class="s1">&#39;redshift_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;shMbound_at_ac&#39;</span><span class="p">,</span> <span class="s1">&#39;snapNum&#39;</span><span class="p">]</span>
    <span class="k">global</span> <span class="n">path</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">names</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/home/zltan/9tian-lightcone/testedition/&#39;</span>
    <span class="n">galbins</span> <span class="o">=</span> <span class="mi">2689</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total files will be read: &#39;</span><span class="p">,</span> <span class="n">galbins</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">output_list</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">props</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Properties will be read: &#39;</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>  <span class="c1"># 创建变量</span>
        <span class="k">if</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">output_list</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = []&#39;</span> <span class="o">%</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">globals</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input property </span><span class="si">%s</span><span class="s1"> is not in prop_list !&#39;</span> <span class="o">%</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="mi">0</span>

<span class="c1">#------------------------------------------------------------------------------</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">galbins</span><span class="p">):</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;9tmock_z05_</span><span class="si">%d</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="n">i</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span> 
            <span class="n">a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> 
            <span class="c1"># print( a )</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
                    <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = np.array(a[&#39;</span><span class="si">%s</span><span class="s2">&#39;])&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">,</span> <span class="nb">globals</span><span class="p">()</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">):</span> 
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
                    <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = np.array(np.concatenate((</span><span class="si">%s</span><span class="s2">, a[&#39;</span><span class="si">%s</span><span class="s2">&#39;]), axis=0))&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="nb">globals</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File &#39;</span><span class="si">%s</span><span class="s2">&#39; not exit !&quot;</span> <span class="o">%</span> <span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Now </span><span class="si">%d</span><span class="s1"> files are read.&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;print(i, &#39;/&#39;, galbins, &#39;</span><span class="se">\t</span><span class="s2"> length now = &#39;, len(</span><span class="si">%s</span><span class="s2">))&quot;</span> <span class="o">%</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;np.save(&#39;9tlc0_</span><span class="si">%s</span><span class="s2">.npy&#39;, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>  <span class="c1">###</span>
            <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;print(&#39;Save &quot;9tlc0_</span><span class="si">%s</span><span class="s1">.npy&quot; done, length = &#39;, len(</span><span class="si">%s</span><span class="s1">))&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> 

    <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
    <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;ret = pd.DataFrame(np.array([</span><span class="si">%s</span><span class="s1">]).T, columns=names)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test</span><span class="p">),</span> <span class="nb">globals</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data shaped : &#39;</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Read data done !&#39;</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;It takes </span><span class="si">%s</span><span class="s1"> s.&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span> <span class="p">)</span> 
    <span class="k">return</span> <span class="n">ret</span> </div>

<div class="viewcode-block" id="lightcone4csstmock"><a class="viewcode-back" href="../../../csstmock.dataio.html#csstmock.dataio.io_jiutian.lightcone4csstmock">[docs]</a><span class="k">def</span> <span class="nf">lightcone4csstmock</span><span class="p">():</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; </span>
<span class="sd">    Read the Jiutian lightcone for CSSTMOCK. A small, test edition of Jiutian lightcone by Zhenlin Tan.</span>
<span class="sd">    It takes ~600s to readin. </span>
<span class="sd">    </span>
<span class="sd">    Provided by Zhenlin Tan, Jiaxin Han</span>

<span class="sd">    Return:</span>
<span class="sd">    -------</span>
<span class="sd">    Nsubs: int </span>
<span class="sd">           number of subhalos</span>
<span class="sd">    INPUT_FORT_LONG: ndarray </span>
<span class="sd">           include all int64   type data information</span>
<span class="sd">    INPUT_FORT_DOUBLE: ndarray </span>
<span class="sd">           include all float64 type data information</span>

<span class="sd">    Details of lightcone data:</span>
<span class="sd">    --------</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; INPUT_FORT_LONG (np.int64):</span>
<span class="sd">    &gt;&gt;&gt; 1. &#39;host_id&#39;:   host halo ID, from fof, &#39;group_nr&#39;</span>
<span class="sd">    &gt;&gt;&gt; 2. &#39;rank&#39;:      subhalo order</span>
<span class="sd">    &gt;&gt;&gt; 3. &#39;sub_id&#39;:    &#39;TrackID&#39; </span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; INPUT_FORT_DOUBLE (np.float64): </span>
<span class="sd">    &gt;&gt;&gt; 1.   &#39;ra&#39;: Right Ascension</span>
<span class="sd">    &gt;&gt;&gt; 2.   &#39;dec&#39;: Declination </span>
<span class="sd">    &gt;&gt;&gt; 3.   &#39;d_comoving&#39;: comoving distance</span>
<span class="sd">    &gt;&gt;&gt; 4.   &#39;redshift_true&#39;: cosmology redshift, z_cos</span>
<span class="sd">    &gt;&gt;&gt; 5.   &#39;redshift_obs&#39;: observed redshift, z_obs </span>
<span class="sd">    &gt;&gt;&gt; 6.   &#39;v_lfs&#39;: line-of-sight velocity </span>
<span class="sd">    &gt;&gt;&gt; 7.   &#39;group_mass&#39;:  host halo mass from fof, &#39;group_mass&#39;</span>
<span class="sd">    &gt;&gt;&gt; 8.   &#39;shMbound&#39;: subhalo mass </span>
<span class="sd">    &gt;&gt;&gt; 9.   &#39;PeakMass&#39;: peak mass  </span>
<span class="sd">    &gt;&gt;&gt; 10.   &#39;vmax&#39;:     max circular velocity </span>
<span class="sd">    &gt;&gt;&gt; </span>
<span class="sd">    &gt;&gt;&gt; Note: </span>
<span class="sd">    &gt;&gt;&gt; mass in unit of Msun/h using log values </span>
<span class="sd">    &gt;&gt;&gt; cordinates in unit of Mpc/h </span>
<span class="sd">    &gt;&gt;&gt; velocity in unit of km/s</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="c1"># prop_list = [&#39;trackID&#39;, &#39;hosthaloID&#39;, &#39;rank&#39;, &#39;posx&#39;, &#39;posy&#39;, &#39;posz&#39;, &#39;velx&#39;, &#39;vely&#39;, &#39;velz&#39;, &#39;v_lfs&#39;,</span>
<span class="c1">#              &#39;shMbound&#39;, &#39;d_comoving&#39;, &#39;ra&#39;, &#39;dec&#39;, &#39;vmax&#39;, &#39;PeakMass&#39;, &#39;PeakVmax&#39;, &#39;Mvir&#39;,&#39;Rvir&#39;,</span>
<span class="c1">#              &#39;shBoundM200Crit&#39;,&#39;M200mean&#39;, &#39;redshift_true&#39;, &#39;redshift_obs&#39;, &#39;shMbound_at_ac&#39;, &#39;snapNum&#39;]</span>

    <span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;trackID&#39;</span><span class="p">,</span> <span class="s1">&#39;snapNum&#39;</span><span class="p">,</span> <span class="s1">&#39;hosthaloID&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">,</span> \
             <span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;d_comoving&#39;</span><span class="p">,</span> \
             <span class="s1">&#39;redshift_true&#39;</span><span class="p">,</span> <span class="s1">&#39;redshift_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;v_lfs&#39;</span><span class="p">,</span> \
             <span class="s1">&#39;Mvir&#39;</span><span class="p">,</span> <span class="s1">&#39;shMbound&#39;</span><span class="p">,</span> <span class="s1">&#39;PeakMass&#39;</span><span class="p">,</span> <span class="s1">&#39;vmax&#39;</span><span class="p">]</span> 
    <span class="n">ret</span> <span class="o">=</span> <span class="n">read_edition0</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;trackID&#39;</span><span class="p">,</span> <span class="s1">&#39;snapNum&#39;</span><span class="p">])</span>

    <span class="n">group_path</span> <span class="o">=</span> <span class="s1">&#39;/home/zltan/9tian-lightcone/testedition/group_patch.hdf5&#39;</span>
    <span class="n">group_props</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">group_path</span><span class="p">)</span>
<span class="c1">#    print(ret.iloc[0:10])</span>
<span class="c1">#    print(group_props.iloc[0:10]) </span>

    <span class="n">Nsubs</span>             <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;trackID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="c1"># print(ret[&#39;trackID&#39;].shape )</span>
    <span class="n">INPUT_FORT_LONG</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Nsubs</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>  <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">INPUT_FORT_LONG</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>   <span class="o">=</span> <span class="n">group_props</span><span class="p">[</span><span class="s1">&#39;group_nr&#39;</span><span class="p">][:</span><span class="n">Nsubs</span><span class="p">]</span> 
    <span class="n">INPUT_FORT_LONG</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>   <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span>
    <span class="n">INPUT_FORT_LONG</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>   <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;trackID&#39;</span><span class="p">]</span> 

    <span class="c1"># indx = 7324 == INPUT_FORT_LONG[:,0]</span>
    <span class="c1"># print(INPUT_FORT_LONG[indx,1]) </span>


    <span class="n">INPUT_FORT_DOUBLE</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Nsubs</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>  <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;d_comoving&#39;</span><span class="p">]</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;redshift_true&#39;</span><span class="p">]</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;redshift_obs&#39;</span><span class="p">]</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;v_lfs&#39;</span><span class="p">]</span>
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">group_props</span><span class="p">[</span><span class="s1">&#39;group_mass&#39;</span><span class="p">])[:</span><span class="n">Nsubs</span><span class="p">]</span> 
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="s1">&#39;shMbound&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">10</span> 
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">8</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="s1">&#39;PeakMass&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">10</span> 
    <span class="n">INPUT_FORT_DOUBLE</span><span class="p">[:,</span><span class="mi">9</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">]</span>
    

    <span class="k">return</span> <span class="n">Nsubs</span><span class="p">,</span> <span class="n">INPUT_FORT_LONG</span><span class="p">,</span>  <span class="n">INPUT_FORT_DOUBLE</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span> 
    <span class="c1">#Nsubs, INPUT_FORT_LONG,  INPUT_FORT_DOUBLE = lightcone4csstmock() </span>
    <span class="n">basedir</span> <span class="o">=</span> <span class="s1">&#39;/home/cossim/Jiutian/M1000/&#39;</span> 
    <span class="n">basedir_hbt</span>    <span class="o">=</span> <span class="n">basedir</span> <span class="o">+</span> <span class="s1">&#39;/hbt/&#39;</span>
    <span class="n">basedir_groups</span> <span class="o">=</span> <span class="n">basedir</span> <span class="o">+</span> <span class="s1">&#39;/groups/&#39;</span>
    <span class="n">Nsubs</span><span class="p">,</span> <span class="n">INPUT_FORT_LONG</span><span class="p">,</span>  <span class="n">INPUT_FORT_DOUBLE</span> <span class="o">=</span> <span class="n">collect4csstmock</span><span class="p">(</span><span class="mi">127</span><span class="p">,</span> <span class="n">basedir_groups</span><span class="o">=</span><span class="n">basedir_groups</span><span class="p">,</span> <span class="n">basedir_hbt</span><span class="o">=</span> <span class="n">basedir_hbt</span><span class="p">)</span> 
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;INPUT_FORT_LONG&#39;</span><span class="p">,</span> <span class="n">INPUT_FORT_LONG</span><span class="p">)</span> 
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;INPUT_FORT_DOUBLE&#39;</span><span class="p">,</span> <span class="n">INPUT_FORT_DOUBLE</span><span class="p">)</span> 
    
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__0&#39;</span><span class="p">:</span> 
    <span class="n">snapnum</span> <span class="o">=</span> <span class="mi">127</span> 
    <span class="n">basedir</span> <span class="o">=</span> <span class="s1">&#39;/home/cossim/Jiutian/M1000/&#39;</span> 
    <span class="n">basedir_hbt</span>    <span class="o">=</span> <span class="n">basedir</span> <span class="o">+</span> <span class="s1">&#39;/hbt/&#39;</span>
    <span class="n">basedir_groups</span> <span class="o">=</span> <span class="n">basedir</span> <span class="o">+</span> <span class="s1">&#39;/groups/&#39;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">Nsubs</span><span class="p">,</span> <span class="n">INPUT_FORT_LONG</span><span class="p">,</span> <span class="n">INPUT_FORT_DOUBLE</span> <span class="o">=</span> <span class="n">collect4csstmock</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">basedir_hbt</span><span class="p">,</span> <span class="n">basedir_groups</span><span class="p">)</span> 
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The time of collect4csstmock for </span><span class="si">%s</span><span class="s1"> snapshot is </span><span class="si">%.3f</span><span class="s1"> s&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">snapnum</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Nsubs</span><span class="p">)</span> 
    <span class="nb">print</span><span class="p">(</span><span class="n">INPUT_FORT_LONG</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 
    <span class="nb">print</span><span class="p">(</span><span class="n">INPUT_FORT_DOUBLE</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;INPUT_FORT_LONG&#39;</span><span class="p">,</span> <span class="n">INPUT_FORT_LONG</span><span class="p">)</span> 
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;INPUT_FORT_DOUBLE&#39;</span><span class="p">,</span> <span class="n">INPUT_FORT_DOUBLE</span><span class="p">)</span> 
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, 0.0.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>